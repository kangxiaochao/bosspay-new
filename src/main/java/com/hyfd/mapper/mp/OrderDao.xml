<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hyfd.dao.mp.OrderDao">
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, order_id, agent_order_id, provider_order_id, agent_id, dispatcher_provider_id, 
    provider_id, pkg_id, bill_type, status, result_code, phone, biz_type, fee, value, agent_discount_id, 
    agent_discount, provider_discount_id, provider_discount, deal_count, deal_path, callback_url, 
    callback_status, apply_date, create_date, end_date, callback_date, consumed_time
  </sql>
  <sql id="Base_Column_List_For_OrderId">
    id, order_id as orderId, agent_order_id as agentOrderId, 
    provider_order_id as providerOrderId, agent_id as agentId, 
    dispatcher_provider_id as dispatcherProviderId, 
    provider_id as providerId, pkg_id as pkgId, bill_type as billType, status, result_code as resultCode, 
    phone, biz_type as bizType, fee, value, agent_discount_id as agentDiscountId, 
    agent_discount as agentDiscount, provider_discount_id as providerDiscountId, 
    provider_discount as providerDiscount, deal_count as dealCount, deal_path as dealPath,
    callback_url as callbackUrl,callback_status as callbackStatus,
    date_format(apply_date, '%Y-%m-%d %H:%i:%s') as applyDate, 
    date_format(create_date, '%Y-%m-%d %H:%i:%s') as createDate,
    date_format(end_date, '%Y-%m-%d %H:%i:%s') as endDate,
    date_format(callback_date, '%Y-%m-%d %H:%i:%s') as callbackDate,
    consumed_time as consumedTime
  </sql>
  <sql id="Base_Column_List_By">
    a.id, a.order_id as orderId, a.agent_order_id as agentOrderId, 
    a.provider_order_id as providerOrderId,a.agent_id as agentId, 
    a.dispatcher_provider_id as dispatcherProviderId, 
    a.provider_id as providerId,a.pkg_id as pkgId, a.bill_type as billType,a.status, a.result_code as resultCode, 
   	a.phone, a.biz_type as bizType, a.fee,a.value, a.agent_discount_id as agentDiscountId, 
    a.agent_discount as agentDiscount, a.provider_discount_id as providerDiscountId, 
    a.provider_discount as providerDiscount, a.deal_count as dealCount, a.deal_path as dealPath,
    a.callback_url as callbackUrl,a.callback_status as callbackStatus,
   	date_format(a.apply_date, '%Y-%m-%d %H:%i:%s') as applyDate,
   	date_format(a.create_date, '%Y-%m-%d %H:%i:%s') as createDate,
    date_format(a.end_date, '%Y-%m-%d %H:%i:%s') as endDate,
	b.name AS agent,c.name AS dispatcherProvider,d.name as provider,
	b.channel_person AS channelPerson,
	date_format(a.callback_date, '%Y-%m-%d %H:%i:%s') as callbackDate,
    a.consumed_time as consumedTime,ps.province_code as province
  </sql>
  
  <select id="getOrderCount" resultType="java.lang.Integer">
	    select 
	    	count(1)
	    from 
			mp_order a
	    left join mp_phone_section ps on left(a.phone,7) = ps.section
	    left join mp_agent b on a.agent_id = b.id
	    left join mp_provider d on a.provider_id = d.id 
	    where 
	    	1 = 1
	    	<if test="orderId != null and orderId != ''"  >
				       and a.order_id = #{orderId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentOrderId != null and agentOrderId != ''">
				       and a.agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentParentId != null and agentParentId != ''" >
				       and a.agent_id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId})
				    </if>
				    <if test="channelPerson != null and channelPerson != ''" >
				       and a.agent_id in(select id from mp_agent where channel_person=#{channelPerson})
				    </if>
				    <if test="providerOrderId != null and providerOrderId != ''">
				       and a.provider_order_id = #{providerOrderId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentId != null and agentId != ''" >
				       and a.agent_id = #{agentId,jdbcType=VARCHAR}
				    </if>
				    <if test="dispatcherProviderId != null and dispatcherProviderId != ''">
				       and a.dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR}
				    </if>
				    <if test="providerId != null and providerId != ''">
				       and a.provider_id = #{providerId,jdbcType=VARCHAR}
				    </if>
				    <if test="pkgId != null and pkgId != ''">
				       and a.pkg_id = #{pkgId,jdbcType=VARCHAR}
				    </if>
				    <if test="billType != null and billType != ''">
				       and a.bill_type = #{billType,jdbcType=VARCHAR}
				    </if>
				    <if test="status != null and status != ''">
				       and a.status = #{status,jdbcType=VARCHAR}
				    </if>
				    <if test="resultCode != null and resultCode != ''">
				       and a.result_code = #{resultCode,jdbcType=VARCHAR}
				    </if>
				    <if test="phone != null and phone != ''">
				       and a.phone = #{phone,jdbcType=VARCHAR}
				    </if>
				    <if test="bizType != null and bizType != ''">
				       and a.biz_type = #{bizType,jdbcType=CHAR}
				    </if>
				    <if test="fee != null and fee != ''">
				       and a.fee = #{fee,jdbcType=DECIMAL}
				    </if>
				    <if test="value != null and value != ''">
				       and a.value = #{value,jdbcType=DECIMAL}
				    </if>
				    <if test="agentDiscountId != null and agentDiscountId != ''">
				       and a.agent_discount_id = #{agentDiscountId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentDiscount != null and agentDiscount != ''">
				       and a.agent_discount = #{agentDiscount,jdbcType=DECIMAL}
				    </if>
				    <if test="providerDiscountId != null and providerDiscountId != ''">
				       and a.provider_discount_id = #{providerDiscountId,jdbcType=VARCHAR}
				    </if>
				    <if test="providerDiscount != null and providerDiscount != ''">
				       and a.provider_discount = #{providerDiscount,jdbcType=DECIMAL}
				    </if>
				    <if test="dealCount != null and dealCount != ''">
				       and a.deal_count = #{dealCount,jdbcType=INTEGER}
				    </if>
				    <if test="callbackUrl != null and callbackUrl != ''">
				       and a.callback_url = #{callbackUrl,jdbcType=VARCHAR}
				    </if>
				    <if test="callbackStatus != null and callbackStatus != ''">
				       and a.callback_status = #{callbackStatus,jdbcType=CHAR}
				    </if>
				    <if test="applyDate != null and applyDate != ''">
				       and a.apply_date &gt;= #{applyDate,jdbcType=TIMESTAMP}
				    </if>
				    <if test="endDate != null and endDate != ''">
				       and a.apply_date &lt; #{endDate,jdbcType=TIMESTAMP}
				    </if>
				    <if test="(applyDate == null or applyDate == '') and (endDate == null or endDate == '')">
				       and a.apply_date &gt;= curdate()
				    </if>
				    <if test="channelPerson != null and channelPerson != ''" >
				       and b.channel_person = #{channelPerson,jdbcType=VARCHAR}
				    </if>
				    <if test="provinceCode != null and provinceCode != ''">
				       and ps.province_code like concat('%',#{provinceCode,jdbcType=VARCHAR},'%')
				    </if>
  </select>
  <select id="OrderList" resultType="java.util.Map">
  SELECT a.id, a.order_id as orderId, a.agent_order_id as agentOrderId, 
    a.provider_order_id as providerOrderId,a.agent_id as agentId, 
    a.dispatcher_provider_id as dispatcherProviderId, 
    a.provider_id as providerId, a.status, a.result_code as resultCode, 
   	a.phone, a.biz_type as bizType, a.fee,a.value, a.deal_count as dealCount, a.deal_path as dealPath,
    a.callback_url as callbackUrl,a.callback_status as callbackStatus,
    date_format(a.apply_date, '%Y-%m-%d %H:%i:%s') as applyDate, date_format(a.end_date, '%Y-%m-%d %H:%i:%s') as endDate,b.name AS agent,c.name AS dispatcherProvider,d.name as provider from mp_order a,mp_agent b,mp_provider_physical_channel c,mp_provider d
WHERE a.agent_id=b.id and a.dispatcher_provider_id=c.id AND a.provider_id = d.id
  </select>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from mp_order
    where id = #{id,jdbcType=VARCHAR}
  </select>
<!--   <select id="selectByTask" resultType="java.util.Map"> -->
<!--     select  -->
<!--     	a.id, a.order_id as orderId, a.agent_order_id as agentOrderId,  -->
<!-- 	    a.provider_order_id as providerOrderId,a.agent_id as agentId,  -->
<!-- 	    a.dispatcher_provider_id as dispatcherProviderId,  -->
<!-- 	    a.provider_id as providerId,a.pkg_id as pkgId, a.bill_type as billType,a.status, a.result_code as resultCode,  -->
<!-- 	   	a.phone, a.biz_type as bizType, a.fee,a.value, a.agent_discount_id as agentDiscountId,  -->
<!-- 	    a.agent_discount as agentDiscount, a.provider_discount_id as providerDiscountId,  -->
<!-- 	    a.provider_discount as providerDiscount, a.deal_count as dealCount, a.deal_path as dealPath, -->
<!-- 	    a.callback_url as callbackUrl,a.callback_status as callbackStatus, -->
<!-- 	   	date_format(a.apply_date, '%Y-%m-%d %H:%i:%s') as applyDate, -->
<!-- 	   	date_format(a.create_date, '%Y-%m-%d %H:%i:%s') as createDate, -->
<!-- 	    date_format(a.end_date, '%Y-%m-%d %H:%i:%s') as endDate, -->
<!-- 		b.name AS agent,c.name AS dispatcherProvider,d.name as provider, -->
<!-- 		b.channel_person AS channelPerson, -->
<!-- 		date_format(a.callback_date, '%Y-%m-%d %H:%i:%s') as callbackDate, -->
<!-- 	    a.consumed_time as consumedTime -->
<!--     from mp_order a,mp_agent b,mp_provider_physical_channel c,mp_provider d where 1 = 1  -->
<!--     and a.agent_id=b.id and a.dispatcher_provider_id=c.id AND a.provider_id = d.id -->
<!--     <if test="dispatcherProviderId != null and dispatcherProviderId != ''"> -->
<!--        and a.dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR} -->
<!--     </if> -->
<!--     <if test="status != null and status != ''"> -->
<!--        and a.status = #{status,jdbcType=VARCHAR} -->
<!--     </if> -->
<!--   </select> -->
	<select id="selectByTask" resultType="java.util.Map">
		SELECT
			a.order_id AS orderId,
			a.provider_order_id AS providerOrderId,
			a.phone
		FROM
			mp_order a
		WHERE
			1 = 1
		<if test="dispatcherProviderId != null and dispatcherProviderId != ''">
			and a.dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR}
		</if>
		<if test="status != null and status != ''">
			and a.status = #{status,jdbcType=VARCHAR}
		</if>
	</select>
  <select id="selectProfit" resultType="java.lang.Double">
    select IFNULL((
	    select 
	    	SUM(fee * (agent_discount - provider_discount))
	    from mp_order where 1 = 1
	    <if	test = "agentId != null and agentId != ''">
	    	and agent_id = #{agentId,jdbcType = VARCHAR}
	    </if>
	    <if test = "isToday">
	    	and DATE(apply_date) = CURDATE()
	    </if>
    ),0)
  </select>
  <select id="countOrder" resultType="java.lang.Integer">
  	select 
  		count(1)
  	from mp_order where 1=1
  	<if	test = "agentId != null and agentId != ''">
    	and agent_id = #{agentId,jdbcType = VARCHAR}
    </if>
    <if test = "status != null and status != ''">
    	and status = #{status,jdbcType = VARCHAR}
    </if>
    <if test = "isToday">
    	and DATE(apply_date) = CURDATE()
    </if>
  </select>
  <select id="countOrderByTask" resultType="java.lang.Integer">
  	select 
  		count(1)
  	from mp_order where 1=1
  	<if test="dispatcherProviderId != null and dispatcherProviderId != ''">
       and a.dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR}
    </if>
       and DATE(apply_date) = date_sub(curdate(),interval 1 day)
  </select>
  <select id="selectPhysicalChannelProfit" resultType="java.util.Map">
	SELECT
		a.dispatcher_provider_id,
		b.`name` as name,
		count(*) AS num,
		(SELECT COUNT(1) from mp_order
			WHERE 1 = 1
		<if test="agentId != null and agentId != ''">
			and agent_id = #{agentId,jdbcType = VARCHAR}
		</if>
		<if test="startDate != null and startDate != ''">
			and create_date &gt; #{startDate,jdbcType = VARCHAR}
		</if>
		<if test="endDate != null and endDate != ''">
			and create_date &lt; #{endDate,jdbcType = VARCHAR}
		</if>	
		) as sum,
		sum(a.fee) AS fee,
		sum(a.fee * a.agent_discount) AS agent_fee,
		sum(IF(a.STATUS = '1', 1, 0)) AS num_1,
		sum(IF(a.STATUS = '1', a.fee, 0)) AS fee_1,
		sum(IF (a.STATUS = '1',a.fee * a.agent_discount,0)) AS agent_fee_1,
		sum(IF(a.STATUS = '2', 1, 0)) AS num_2,
		sum(IF(a.STATUS = '2', a.fee, 0)) AS fee_2,
		sum(IF(a.STATUS = '2',a.fee * a.agent_discount,0)) AS agent_fee_2,
		sum(IF(a.STATUS = '3', 1, 0)) AS num_3,
		sum(IF(a.STATUS = '3', a.fee, 0)) AS fee_3,
		sum(IF(a.STATUS = '3',a.fee * a.agent_discount,0)) AS agent_fee_3,
		sum(IF(a.STATUS = '3',a.fee * (a.agent_discount-a.provider_discount),0)) AS profit,
		sum(IF(a.STATUS = '4', 1, 0)) AS num_4,
		sum(IF(a.STATUS = '4', a.fee, 0)) AS fee_4,
		sum(IF(a.STATUS = '4',a.fee * a.agent_discount,0)) AS agent_fee_4
	FROM
		mp_order a
	INNER JOIN mp_provider_physical_channel b ON a.dispatcher_provider_id = b.id
	WHERE 1 = 1
	<if test="agentId != null and agentId != ''">
		and a.agent_id = #{agentId,jdbcType = VARCHAR}
	</if>
	<if test="startDate != null and startDate != ''">
		and a.create_date &gt; #{startDate,jdbcType = VARCHAR}
	</if>
	<if test="endDate != null and endDate != ''">
		and a.create_date &lt; #{endDate,jdbcType = VARCHAR}
	</if>
	GROUP BY
		a.dispatcher_provider_id
	HAVING
		a.dispatcher_provider_id IS NOT NULL
	ORDER BY profit DESC
  </select>
	<!-- 查询账单列表页面数据 -->
  	<select id = "selectProviderStatementList" resultType = "java.util.Map">
	 	SELECT
			a.dispatcher_provider_id AS dispatcher_provider_id,
			a.provider_id AS provider_id,
			b. NAME AS NAME,
			IFNULL(e.province_code,f.province_code) AS province_code,
			count(*) AS num,
			sum(a.fee) AS fee,
			sum(a.fee * a.provider_discount) AS agent_fee,
			IFNULL(concat(b.NAME, e.province_code, d.short_name),concat(b.NAME, f.province_code, d.short_name)) AS channel_name,
			sum(IF(STATUS = '1', 1, 0)) AS num_1,
			sum(IF(STATUS = '1', a.fee, 0)) AS fee_1,
			sum(IF (STATUS = '1',a.fee * a.provider_discount,0)) AS agent_fee_1,
			sum(IF(STATUS = '2', 1, 0)) AS num_2,
			sum(IF(STATUS = '2', a.fee, 0)) AS fee_2,
			sum(IF (STATUS = '2',a.fee * a.provider_discount,0)) AS agent_fee_2,
			sum(IF(STATUS = '3', 1, 0)) AS num_3,
			sum(IF(STATUS = '3', a.fee, 0)) AS fee_3,
			sum(IF (STATUS = '3',a.fee * a.provider_discount,0)) AS agent_fee_3,
			sum(IF(STATUS = '4', 1, 0)) AS num_4,
			sum(IF(STATUS = '4', a.fee, 0)) AS fee_4,
			sum(IF (STATUS = '4',a.fee * a.provider_discount,0)) AS agent_fee_4
		FROM
			mp_order a
		LEFT JOIN mp_provider_physical_channel b ON a.dispatcher_provider_id = b.id
		LEFT JOIN mp_agent_bill_discount c ON a.agent_discount_id = c.id
		LEFT JOIN mp_provider d ON a.provider_id = d.id
		LEFT JOIN mp_provider_bill_discount e ON a.provider_discount_id = e.id
		LEFT JOIN mp_phone_section f on LEFT(a.phone,7) = f.section
		WHERE 1 = 1
		<if test="bizType != null and bizType != ''">
			and a.biz_type = #{bizType,jdbcType = CHAR}
		</if>
		<if test="agentName != null and agentName != ''">
			and a.agent_id = (select id from mp_agent where name = #{agentName,jdbcType = VARCHAR})
		</if>
		<if test="startDate != null and startDate != ''">
			and a.create_date &gt;= #{startDate,jdbcType = VARCHAR}
		</if>
		<if test="endDate != null and endDate != ''">
			and a.create_date &lt; #{endDate,jdbcType = VARCHAR}
		</if>
		GROUP BY
			a.dispatcher_provider_id,
			a.provider_id
			<if test="channelName != null and channelName != ''">
				having channel_name like concat(concat('%',#{channelName,jdbcType = VARCHAR}),'%')
			</if>
		ORDER BY dispatcher_provider_id
  	</select>
  
	<!--   查询账单列表页面数据新方法 -->
  	<select id = "selectProviderStatementListExt" resultType = "java.util.Map">
	 	select 
			k1.dispatcher_provider_id,
			k1.provider_id,
			k1.`name`,
			k1.channel_name,
			k1.providerName,
			k1.province_code,
			count(1) AS num,
			sum(k1.fee) AS fee,
			sum(k1.fee * k1.provider_discount) AS agent_fee,
			sum(IF(k1.`STATUS` = '1', 1, 0)) AS num_1,
			sum(IF(k1.`STATUS` = '1', k1.fee, 0)) AS fee_1,
			sum(IF (k1.`STATUS` = '1',k1.fee * k1.provider_discount,0)) AS agent_fee_1,
			sum(IF(k1.`STATUS` = '2', 1, 0)) AS num_2,
			sum(IF(k1.`STATUS` = '2', k1.fee, 0)) AS fee_2,
			sum(IF (k1.`STATUS` = '2',k1.fee * k1.provider_discount,0)) AS agent_fee_2,
			sum(IF(k1.`STATUS` = '3', 1, 0)) AS num_3,
			sum(IF(k1.`STATUS` = '3', k1.fee, 0)) AS fee_3,
			sum(IF (k1.`STATUS` = '3',k1.fee * k1.provider_discount,0)) AS agent_fee_3,
			sum(IF(k1.`STATUS` = '4', 1, 0)) AS num_4,
			sum(IF(k1.`STATUS` = '4', k1.fee, 0)) AS fee_4,
			sum(IF (k1.`STATUS` = '4',k1.fee * k1.provider_discount,0)) AS agent_fee_4
		from (
			SELECT
				a.dispatcher_provider_id,
				a.provider_id,
				b.`name`,
				c.short_name as providerName,
				'' as province_code,
				concat(b.`name`,c.short_name) as channel_name,
				a.fee,
				a.provider_discount,
				a.`status`
			FROM
				mp_order a 
			LEFT JOIN mp_provider_physical_channel b ON a.dispatcher_provider_id = b.id 
			LEFT JOIN mp_provider c ON a.provider_id = c.id 
			left join mp_phone_section d ON a.provider_id = d.provider_id and left(a.phone,7) = d.section
			left join mp_agent e on a.agent_id = e.id
			WHERE 
				1 = 1 
				and a.provider_id in('0000000001','0000000002','0000000003')
				<if test="bizType != null and bizType != ''">
					and a.biz_type = #{bizType,jdbcType = CHAR}
				</if>
				<if test="startDate != null and startDate != ''">
					and a.create_date &gt;= #{startDate,jdbcType = VARCHAR}
				</if>
				<if test="endDate != null and endDate != ''">
					and a.create_date &lt; #{endDate,jdbcType = VARCHAR}
				</if>
				<if test="channelName != null and channelName != ''">
					and (
						b.`name` like concat('%',#{channelName,jdbcType = VARCHAR},'%')
						or
						c.short_name like concat('%',#{channelName,jdbcType = VARCHAR},'%')
					)
				</if>
				<if test="agentName != null and agentName != ''">
					and e.`name` like concat('%',#{agentName,jdbcType = VARCHAR},'%')
				</if>
		) k1
		group by k1.dispatcher_provider_id,k1.channel_name
		union
	 	select 
			k1.dispatcher_provider_id,
			k1.provider_id,
			k1.`name`,
			k1.channel_name,
			k1.providerName,
			k1.province_code,
			count(1) AS num,
			sum(k1.fee) AS fee,
			sum(k1.fee * k1.provider_discount) AS agent_fee,
			sum(IF(k1.`STATUS` = '1', 1, 0)) AS num_1,
			sum(IF(k1.`STATUS` = '1', k1.fee, 0)) AS fee_1,
			sum(IF (k1.`STATUS` = '1',k1.fee * k1.provider_discount,0)) AS agent_fee_1,
			sum(IF(k1.`STATUS` = '2', 1, 0)) AS num_2,
			sum(IF(k1.`STATUS` = '2', k1.fee, 0)) AS fee_2,
			sum(IF (k1.`STATUS` = '2',k1.fee * k1.provider_discount,0)) AS agent_fee_2,
			sum(IF(k1.`STATUS` = '3', 1, 0)) AS num_3,
			sum(IF(k1.`STATUS` = '3', k1.fee, 0)) AS fee_3,
			sum(IF (k1.`STATUS` = '3',k1.fee * k1.provider_discount,0)) AS agent_fee_3,
			sum(IF(k1.`STATUS` = '4', 1, 0)) AS num_4,
			sum(IF(k1.`STATUS` = '4', k1.fee, 0)) AS fee_4,
			sum(IF (k1.`STATUS` = '4',k1.fee * k1.provider_discount,0)) AS agent_fee_4
		from (
			SELECT
				a.dispatcher_provider_id,
				a.provider_id,
				b.`name`,
				c.short_name as providerName,
				'全国' as province_code,
				concat(b.`name`,'全国',c.short_name) as channel_name,
				a.fee,
				a.provider_discount,
				a.`status`
			FROM
				mp_order a 
			LEFT JOIN mp_provider_physical_channel b ON a.dispatcher_provider_id = b.id 
			LEFT JOIN mp_provider c ON a.provider_id = c.id 
			left join mp_phone_section d ON a.provider_id = d.provider_id and left(a.phone,7) = d.section
			left join mp_agent e on a.agent_id = e.id
			WHERE 
				1 = 1 
				and a.provider_id not in('0000000001','0000000002','0000000003')
				<if test="bizType != null and bizType != ''">
					and a.biz_type = #{bizType,jdbcType = CHAR}
				</if>
				<if test="startDate != null and startDate != ''">
					and a.apply_date &gt;= #{startDate,jdbcType = VARCHAR}
				</if>
				<if test="endDate != null and endDate != ''">
					and a.apply_date &lt; #{endDate,jdbcType = VARCHAR}
				</if>
				<if test="channelName != null and channelName != ''">
					and (
						b.`name` like concat('%',#{channelName,jdbcType = VARCHAR},'%')
						or
						c.short_name like concat('%',#{channelName,jdbcType = VARCHAR},'%')
					)
				</if>
				<if test="agentName != null and agentName != ''">
					and e.`name` like concat('%',#{agentName,jdbcType = VARCHAR},'%')
				</if>
		) k1
		group by k1.dispatcher_provider_id,k1.channel_name
 	</select>
 	
    <select id = "countProviderStatementList" resultType = "java.lang.Integer">
 	select count(1) from (
	 	SELECT
			a.dispatcher_provider_id AS dispatcher_provider_id,
			a.provider_id AS provider_id,
			b. NAME AS NAME,
			IFNULL(e.province_code,f.province_code) AS province_code,
			count(*) AS num,
			sum(a.fee) AS fee,
			sum(a.fee * a.provider_discount) AS agent_fee,
			IFNULL(concat(b.NAME, e.province_code, d.short_name),concat(b.NAME, f.province_code, d.short_name)) AS channel_name,
			sum(IF(STATUS = '1', 1, 0)) AS num_1,
			sum(IF(STATUS = '1', a.fee, 0)) AS fee_1,
			sum(IF (STATUS = '1',a.fee * a.provider_discount,0)) AS agent_fee_1,
			sum(IF(STATUS = '2', 1, 0)) AS num_2,
			sum(IF(STATUS = '2', a.fee, 0)) AS fee_2,
			sum(IF (STATUS = '2',a.fee * a.provider_discount,0)) AS agent_fee_2,
			sum(IF(STATUS = '3', 1, 0)) AS num_3,
			sum(IF(STATUS = '3', a.fee, 0)) AS fee_3,
			sum(IF (STATUS = '3',a.fee * a.provider_discount,0)) AS agent_fee_3,
			sum(IF(STATUS = '4', 1, 0)) AS num_4,
			sum(IF(STATUS = '4', a.fee, 0)) AS fee_4,
			sum(IF (STATUS = '4',a.fee * a.provider_discount,0)) AS agent_fee_4
		FROM
			mp_order a
		LEFT JOIN mp_provider_physical_channel b ON a.dispatcher_provider_id = b.id
		LEFT JOIN mp_agent_bill_discount c ON a.agent_discount_id = c.id
		LEFT JOIN mp_provider d ON a.provider_id = d.id
		LEFT JOIN mp_provider_bill_discount e ON a.provider_discount_id = e.id
		LEFT JOIN mp_phone_section f on LEFT(a.phone,7) = f.section
		WHERE 1 = 1
		<if test="bizType != null and bizType != ''">
			and a.biz_type = #{bizType,jdbcType = CHAR}
		</if>
		<if test="agentName != null and agentName != ''">
			and a.agent_id = (select id from mp_agent where name = #{agentName,jdbcType = VARCHAR})
		</if>
		<if test="startDate != null and startDate != ''">
			and a.create_date &gt;= #{startDate,jdbcType = VARCHAR}
		</if>
		<if test="endDate != null and endDate != ''">
			and a.create_date &lt; #{endDate,jdbcType = VARCHAR}
		</if>
		GROUP BY
			a.dispatcher_provider_id,
			a.provider_id
			<if test="channelName != null and channelName != ''">
				having channel_name like concat(concat('%',#{channelName,jdbcType = VARCHAR}),'%')
			</if>) p
  	</select>
  	<!-- 查询账单列表页面数据总数新方法 -->
    <select id = "countProviderStatementListExt" resultType = "java.lang.Integer">
	 	select count(1) from (
		 	select 
				k1.dispatcher_provider_id,
				k1.provider_id,
				k1.`name`,
				k1.channel_name,
				k1.providerName,
				k1.province_code,
				count(1) AS num,
				sum(k1.fee) AS fee,
				sum(k1.fee * k1.provider_discount) AS agent_fee,
				sum(IF(k1.`STATUS` = '1', 1, 0)) AS num_1,
				sum(IF(k1.`STATUS` = '1', k1.fee, 0)) AS fee_1,
				sum(IF (k1.`STATUS` = '1',k1.fee * k1.provider_discount,0)) AS agent_fee_1,
				sum(IF(k1.`STATUS` = '2', 1, 0)) AS num_2,
				sum(IF(k1.`STATUS` = '2', k1.fee, 0)) AS fee_2,
				sum(IF (k1.`STATUS` = '2',k1.fee * k1.provider_discount,0)) AS agent_fee_2,
				sum(IF(k1.`STATUS` = '3', 1, 0)) AS num_3,
				sum(IF(k1.`STATUS` = '3', k1.fee, 0)) AS fee_3,
				sum(IF (k1.`STATUS` = '3',k1.fee * k1.provider_discount,0)) AS agent_fee_3,
				sum(IF(k1.`STATUS` = '4', 1, 0)) AS num_4,
				sum(IF(k1.`STATUS` = '4', k1.fee, 0)) AS fee_4,
				sum(IF (k1.`STATUS` = '4',k1.fee * k1.provider_discount,0)) AS agent_fee_4
			from (
				SELECT
					a.dispatcher_provider_id,
					a.provider_id,
					b.`name`,
					c.short_name as providerName,
					d.province_code,
					concat(b.`name`,c.short_name) as channel_name,
					a.fee,
					a.provider_discount,
					a.`status`
				FROM
					mp_order a 
				LEFT JOIN mp_provider_physical_channel b ON a.dispatcher_provider_id = b.id 
				LEFT JOIN mp_provider c ON a.provider_id = c.id 
				left join mp_phone_section d ON a.provider_id = d.provider_id and left(a.phone,7) = d.section
				left join mp_agent e on a.agent_id = e.id
				WHERE 
					1 = 1 
					and a.provider_id in('0000000001','0000000002','0000000003')
					<if test="bizType != null and bizType != ''">
						and a.biz_type = #{bizType,jdbcType = CHAR}
					</if>
					<if test="startDate != null and startDate != ''">
						and a.apply_date &gt;= #{startDate,jdbcType = VARCHAR}
					</if>
					<if test="endDate != null and endDate != ''">
						and a.apply_date &lt; #{endDate,jdbcType = VARCHAR}
					</if>
					<if test="channelName != null and channelName != ''">
						and (
							b.`name` like concat('%',#{channelName,jdbcType = VARCHAR},'%')
							or
							c.short_name like concat('%',#{channelName,jdbcType = VARCHAR},'%')
						)
					</if>
					<if test="agentName != null and agentName != ''">
						and e.`name` like concat('%',#{agentName,jdbcType = VARCHAR},'%')
					</if>
			) k1
			group by k1.dispatcher_provider_id,k1.channel_name
			union
		 	select 
				k1.dispatcher_provider_id,
				k1.provider_id,
				k1.`name`,
				k1.channel_name,
				k1.providerName,
				k1.province_code,
				count(1) AS num,
				sum(k1.fee) AS fee,
				sum(k1.fee * k1.provider_discount) AS agent_fee,
				sum(IF(k1.`STATUS` = '1', 1, 0)) AS num_1,
				sum(IF(k1.`STATUS` = '1', k1.fee, 0)) AS fee_1,
				sum(IF (k1.`STATUS` = '1',k1.fee * k1.provider_discount,0)) AS agent_fee_1,
				sum(IF(k1.`STATUS` = '2', 1, 0)) AS num_2,
				sum(IF(k1.`STATUS` = '2', k1.fee, 0)) AS fee_2,
				sum(IF (k1.`STATUS` = '2',k1.fee * k1.provider_discount,0)) AS agent_fee_2,
				sum(IF(k1.`STATUS` = '3', 1, 0)) AS num_3,
				sum(IF(k1.`STATUS` = '3', k1.fee, 0)) AS fee_3,
				sum(IF (k1.`STATUS` = '3',k1.fee * k1.provider_discount,0)) AS agent_fee_3,
				sum(IF(k1.`STATUS` = '4', 1, 0)) AS num_4,
				sum(IF(k1.`STATUS` = '4', k1.fee, 0)) AS fee_4,
				sum(IF (k1.`STATUS` = '4',k1.fee * k1.provider_discount,0)) AS agent_fee_4
			from (
				SELECT
					a.dispatcher_provider_id,
					a.provider_id,
					b.`name`,
					c.short_name as providerName,
					'全国' as province_code,
					concat(b.`name`,'全国',c.short_name) as channel_name,
					a.fee,
					a.provider_discount,
					a.`status`
				FROM
					mp_order a 
				LEFT JOIN mp_provider_physical_channel b ON a.dispatcher_provider_id = b.id 
				LEFT JOIN mp_provider c ON a.provider_id = c.id 
				left join mp_phone_section d ON a.provider_id = d.provider_id and left(a.phone,7) = d.section
				left join mp_agent e on a.agent_id = e.id
				WHERE 
					1 = 1 
					and a.provider_id not in('0000000001','0000000002','0000000003')
					<if test="bizType != null and bizType != ''">
						and a.biz_type = #{bizType,jdbcType = CHAR}
					</if>
					<if test="startDate != null and startDate != ''">
						and a.apply_date &gt;= #{startDate,jdbcType = VARCHAR}
					</if>
					<if test="endDate != null and endDate != ''">
						and a.apply_date &lt; #{endDate,jdbcType = VARCHAR}
					</if>
					<if test="channelName != null and channelName != ''">
						and (
							b.`name` like concat('%',#{channelName,jdbcType = VARCHAR},'%')
							or
							c.short_name like concat('%',#{channelName,jdbcType = VARCHAR},'%')
						)
					</if>
					<if test="agentName != null and agentName != ''">
						and e.`name` like concat('%',#{agentName,jdbcType = VARCHAR},'%')
					</if>
			) k1
			group by k1.dispatcher_provider_id,k1.channel_name
		) p
  	</select>
	<!--   代理商账单统计 -->
	<select id = "selectAgentStatementList" resultType = "java.util.Map">
 		SELECT
			a.agent_id AS agent_id,
			d.NAME AS agent_name,
			count(*) AS num,
			sum(a.fee) AS fee,
			sum(a.fee * a.agent_discount) AS agent_fee,
			sum(IF(a.STATUS = '1', 1, 0)) AS num_1,
			sum(IF(a.STATUS = '1', a.fee, 0)) AS fee_1,
			sum(IF (a.STATUS = '1',a.fee * a.agent_discount,0)) AS agent_fee_1,
			sum(IF(a.STATUS = '2', 1, 0)) AS num_2,
			sum(IF(a.STATUS = '2', a.fee, 0)) AS fee_2,
			sum(IF(a.STATUS = '2',a.fee * a.agent_discount,0)) AS agent_fee_2,
			sum(IF(a.STATUS = '3', 1, 0)) AS num_3,
			sum(IF(a.STATUS = '3', a.fee, 0)) AS fee_3,
			sum(IF(a.STATUS = '3',a.fee * a.agent_discount,0)) AS agent_fee_3,
			sum(IF(a.STATUS = '4', 1, 0)) AS num_4,
			sum(IF(a.STATUS = '4', a.fee, 0)) AS fee_4,
			sum(IF(a.STATUS = '4',a.fee * a.agent_discount,0)) AS agent_fee_4
		FROM
			mp_order a
		LEFT JOIN mp_provider_physical_channel b ON a.dispatcher_provider_id = b.id
		LEFT JOIN mp_agent_bill_discount c ON a.agent_discount_id = c.id
		LEFT JOIN mp_agent d ON a.agent_id = d.id
	WHERE 1 = 1
		<if test="bizType != null and bizType != ''">
			and a.biz_type = #{bizType,jdbcType = CHAR}
		</if>
		<if test="agentName != null and agentName != ''">
			and a.agent_id = (select id from mp_agent where name = #{agentName,jdbcType = VARCHAR})
		</if>
		<if test="userAgentId != null and userAgentId != ''">
			and (a.agent_id = #{userAgentId,jdbcType = VARCHAR} or d.parent_id = #{userAgentId,jdbcType = VARCHAR})
		</if>
		<if test="startDate != null and startDate != ''">
			and a.apply_date &gt; #{startDate,jdbcType = VARCHAR}
		</if>
		<if test="endDate != null and endDate != ''">
			and a.apply_date &lt; #{endDate,jdbcType = VARCHAR}
		</if>
	GROUP BY
		a.agent_id
  </select>
    <select id = "countAgentStatementList" resultType = "java.lang.Integer">
 		select count(1) from (
	 		SELECT
				a.agent_id AS agent_id,
				d.NAME AS agent_name,
				count(*) AS num,
				sum(a.fee) AS fee,
				sum(a.fee * a.agent_discount) AS agent_fee,
				sum(IF(a.STATUS = '1', 1, 0)) AS num_1,
				sum(IF(a.STATUS = '1', a.fee, 0)) AS fee_1,
				sum(IF (a.STATUS = '1',a.fee * a.agent_discount,0)) AS agent_fee_1,
				sum(IF(a.STATUS = '2', 1, 0)) AS num_2,
				sum(IF(a.STATUS = '2', a.fee, 0)) AS fee_2,
				sum(IF(a.STATUS = '2',a.fee * a.agent_discount,0)) AS agent_fee_2,
				sum(IF(a.STATUS = '3', 1, 0)) AS num_3,
				sum(IF(a.STATUS = '3', a.fee, 0)) AS fee_3,
				sum(IF(a.STATUS = '3',a.fee * a.agent_discount,0)) AS agent_fee_3,
				sum(IF(a.STATUS = '4', 1, 0)) AS num_4,
				sum(IF(a.STATUS = '4', a.fee, 0)) AS fee_4,
				sum(IF(a.STATUS = '4',a.fee * a.agent_discount,0)) AS agent_fee_4
			FROM
				mp_order a
			LEFT JOIN mp_provider_physical_channel b ON a.dispatcher_provider_id = b.id
			LEFT JOIN mp_agent_bill_discount c ON a.agent_discount_id = c.id
			LEFT JOIN mp_agent d ON a.agent_id = d.id
		WHERE 1 = 1
			<if test="bizType != null and bizType != ''">
				and a.biz_type = #{bizType,jdbcType = CHAR}
			</if>
			<if test="agentName != null and agentName != ''">
				and a.agent_id = (select id from mp_agent where name = #{agentName,jdbcType = VARCHAR})
			</if>
			<if test="userAgentId != null and userAgentId != ''">
				and (a.agent_id = #{userAgentId,jdbcType = VARCHAR} or d.parent_id = #{userAgentId,jdbcType = VARCHAR})
			</if>
			<if test="startDate != null and startDate != ''">
				and a.apply_date &gt; #{startDate,jdbcType = VARCHAR}
			</if>
			<if test="endDate != null and endDate != ''">
				and a.apply_date &lt; #{endDate,jdbcType = VARCHAR}
			</if>
		GROUP BY
			a.agent_id) p
  </select>
  <select id="selectDetailOrderList" resultType="java.util.Map">
  	SELECT
		a.order_id,
		a.agent_order_id,
		a.provider_order_id,
		c.name physicalName,
		concat(c.`name`, '(',b.province_code,')', g.short_name) AS provider_name,
		g.name as provider,
		d.province_code AS province_code,
		a.phone,
		e.`name` AS pkg_name,
		f.`name` AS agent_name,
		date_format(a.apply_date, '%Y-%m-%d %H:%i:%s') as apply_date,
		date_format(a.end_date, '%Y-%m-%d %H:%i:%s') as end_date,
<!-- 		a.`status`, -->
		CASE
            WHEN a.`status`=1
                THEN '提交成功'
            WHEN a.`status` = 2 
                THEN '提交失败'
            WHEN a.`status` = 3
                THEN '充值成功'
            WHEN a.`status` = 4
                THEN '充值失败'
			ELSE '处理中'
    	END AS status,
		a.fee,
		a.fee * h.real_discount as provider_fee,
		a.fee * a.agent_discount as agent_fee,
		a.fee * (
			a.agent_discount - h.real_discount
		) as agent_profit
	FROM
		mp_order a
	LEFT JOIN mp_agent_bill_discount b ON a.agent_discount_id = b.id
	LEFT JOIN mp_provider_physical_channel c ON a.dispatcher_provider_id = c.id
	LEFT JOIN mp_phone_section d on LEFT(a.phone,7) = d.section
	LEFT JOIN mp_bill_pkg e ON a.pkg_id = e.id
	LEFT JOIN mp_agent f ON a.agent_id = f.id
	LEFT JOIN mp_provider g ON a.provider_id = g.id
	LEFT JOIN mp_provider_bill_discount h ON a.provider_discount_id = h.id
	WHERE 1 = 1
	<if test="dispatcherProviderId != null and dispatcherProviderId != ''">
		AND a.dispatcher_provider_id = #{dispatcherProviderId,jdbcType = VARCHAR}
	</if>
	<if test="providerId != null and providerId != ''">
		AND a.provider_id = #{providerId,jdbcType = VARCHAR}
	</if>
	<if test="orderId != null and orderId != ''">
		AND a.order_id = #{orderId,jdbcType = VARCHAR}
	</if>
	<if test="phone != null and phone != ''">
		AND a.phone = #{phone,jdbcType = VARCHAR}
	</if>
	<if test="status != null and status != ''">
		AND a.status = #{status,jdbcType = VARCHAR}
	</if>
	<if test="provinceCode != null and provinceCode != ''">
		AND b.province_code = #{provinceCode,jdbcType = VARCHAR}
	</if>
	<if test="agentId != null and agentId != ''">
		AND a.agent_id = #{agentId,jdbcType = VARCHAR}
	</if>
	<if test="agentName != null and agentName != ''">
		AND f.name = #{agentName,jdbcType = VARCHAR}
	</if>
	<if test="channelName != null and channelName != ''">
		AND c.name like concat(concat('%',#{channelName,jdbcType = VARCHAR}),'%')
	</if>
	<if test="startDate != null and startDate != ''">
		AND a.create_date &gt;= #{startDate,jdbcType = VARCHAR}
	</if>
	<if test="endDate != null and endDate != ''">
		AND a.create_date &lt; #{endDate,jdbcType = VARCHAR}
	</if>
	ORDER BY a.apply_date desc
  </select>
  
  <!-- 获取话费通道账单统计详情列表new -->
  <select id="selectDetailOrderListExt" resultType="java.util.Map">
	select
		a.order_id,
		a.agent_order_id,
		a.provider_order_id,
		b.`name` as physicalName,
		concat(b.`name`,d.province_code,c.short_name) as provider_name,
		c.`name` as provider,
		d.province_code,
		a.phone,
		f.`name` as pkg_name,
		e.`name` as agent_name,
		date_format(a.apply_date, '%Y-%m-%d %H:%i:%s') as apply_date,
		date_format(a.end_date, '%Y-%m-%d %H:%i:%s') as end_date,
		CASE
			WHEN a.`status`=1 THEN '提交成功'
			WHEN a.`status` = 2 THEN '提交失败'
			WHEN a.`status` = 3	THEN '充值成功'
			WHEN a.`status` = 4	THEN '充值失败'
			ELSE '处理中'
		END AS status,
		a.fee,
		a.fee * g.real_discount as provider_fee,
		a.fee * a.agent_discount as agent_fee,
		a.fee * (
			a.agent_discount - g.real_discount
		) as agent_profit
	FROM
	 mp_order a 
	LEFT JOIN mp_provider_physical_channel b ON a.dispatcher_provider_id = b.id 
	LEFT JOIN mp_provider c ON a.provider_id = c.id 
	left join mp_phone_section d ON a.provider_id = d.provider_id and left(a.phone,7) = d.section
	left join mp_agent e on a.agent_id = e.id
	left join mp_bill_pkg f on a.pkg_id = f.id
	left join mp_provider_bill_discount g on a.provider_discount_id = g.id
	WHERE 
		1 = 1 
		<if test="startDate != null and startDate != ''">
			AND a.apply_date &gt; #{startDate,jdbcType = VARCHAR}
		</if>
		<if test="endDate != null and endDate != ''">
			AND a.apply_date &lt; #{endDate,jdbcType = VARCHAR}
		</if>
		<if test="agentId != null and agentId != ''">
			AND a.agent_id = #{agentId,jdbcType = VARCHAR}
		</if>
		<if test="channelName != null and channelName != ''">
			and (
				b.`name` like concat('%',#{channelName,jdbcType = VARCHAR},'%')
				or
				c.short_name like concat('%',#{channelName,jdbcType = VARCHAR},'%')
			)
		</if>
		<if test="physicalChannelName != null and physicalChannelName != ''">
			and b.`name` = #{physicalChannelName,jdbcType = VARCHAR}
		</if>
		<if test="agentName != null and agentName != ''">
			and e.`name` like concat('%',#{agentName,jdbcType = VARCHAR},'%')
		</if>
		<if test="phone != null and phone != ''">
			and a.phone like concat('%',#{phone,jdbcType = VARCHAR},'%')
		</if>
		<if test="orderId != null and orderId != ''">
			and a.order_id like concat('%',#{orderId,jdbcType = VARCHAR},'%')
		</if>
		<if test="status != null and status != ''">
			and a.status = #{status,jdbcType = VARCHAR}
		</if>
		<if test="province != null and province != ''">
			and d.province_code = #{province,jdbcType = VARCHAR}
		</if>
	order by apply_date desc
  </select>
  
  <!-- 获取订单信息 -->
  <select id="selectDetailOrderListCSV" resultType="java.util.Map">
	SELECT
		o.order_id orderId,
		o.agent_order_id agentOrderId,
		o.provider_order_id providerOrderId,
		p.name providerName,
		c.name physicalName,
		o.phone,
		k.name pkgName,
		a.name agentName,
		s.province_code provinceCode,
		date_format(o.apply_date, '%Y-%m-%d %H:%i:%s') applyDate,
		date_format(o.end_date, '%Y-%m-%d %H:%i:%s') endDate,
		CASE
			WHEN o.status = '3' THEN
				'充值成功'
			ELSE
				'充值失败'
			END status,
		 o.fee fee,
		 o.fee * o.agent_discount agentDiscountFee,
		 o.agent_discount agentDiscount,
		 o.fee * o.provider_discount providerDiscountFee,
		 o.provider_discount providerDiscount,
		 o.fee * o.agent_discount - o.fee * o.provider_discount profits
	FROM
		mp_order o
	LEFT JOIN mp_agent a ON a.id = o.agent_id
	LEFT JOIN mp_provider p ON o.provider_id = p.id
	LEFT JOIN mp_bill_pkg k ON o.pkg_id = k.id
	LEFT JOIN mp_phone_section s ON s.section = substring(o.phone, 1, 7)
	LEFT JOIN mp_provider_physical_channel c on o.dispatcher_provider_id=c.id
	WHERE 
		1 = 1 
		<include refid="exportCsvWhere"/>
	order by o.apply_date desc
  </select>
  
  <select id="selectCountCSV" resultType="java.lang.Integer">
  	select 
	    	count(0)
	    from 
	    	(
	    		select id from mp_order
	    		where 1 = 1
	    			<if test="orderId != null and orderId != ''"  >
				       and order_id = #{orderId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentOrderId != null and agentOrderId != ''">
				       and agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentParentId != null and agentParentId != ''" >
				       and agent_id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId})
				    </if>
				    <if test="channelPerson != null and channelPerson != ''" >
				       and agent_id in(select id from mp_agent where channel_person=#{channelPerson})
				    </if>
				    <if test="providerOrderId != null and providerOrderId != ''">
				       and provider_order_id = #{providerOrderId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentId != null and agentId != ''" >
				       and agent_id = #{agentId,jdbcType=VARCHAR}
				    </if>
				    <if test="dispatcherProviderId != null and dispatcherProviderId != ''">
				       and dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR}
				    </if>
				    <if test="providerId != null and providerId != ''">
				       and provider_id = #{providerId,jdbcType=VARCHAR}
				    </if>
				    <if test="pkgId != null and pkgId != ''">
				       and pkg_id = #{pkgId,jdbcType=VARCHAR}
				    </if>
				    <if test="billType != null and billType != ''">
				       and bill_type = #{billType,jdbcType=VARCHAR}
				    </if>
				    <if test="status != null and status != ''">
				       and status = #{status,jdbcType=VARCHAR}
				    </if>
				    <if test="resultCode != null and resultCode != ''">
				       and result_code = #{resultCode,jdbcType=VARCHAR}
				    </if>
				    <if test="phone != null and phone != ''">
				       and phone = #{phone,jdbcType=VARCHAR}
				    </if>
				    <if test="bizType != null and bizType != ''">
				       and biz_type = #{bizType,jdbcType=CHAR}
				    </if>
				    <if test="fee != null and fee != ''">
				       and fee = #{fee,jdbcType=DECIMAL}
				    </if>
				    <if test="value != null and value != ''">
				       and value = #{value,jdbcType=DECIMAL}
				    </if>
				    <if test="agentDiscountId != null and agentDiscountId != ''">
				       and agent_discount_id = #{agentDiscountId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentDiscount != null and agentDiscount != ''">
				       and agent_discount = #{agentDiscount,jdbcType=DECIMAL}
				    </if>
				    <if test="providerDiscountId != null and providerDiscountId != ''">
				       and provider_discount_id = #{providerDiscountId,jdbcType=VARCHAR}
				    </if>
				    <if test="providerDiscount != null and providerDiscount != ''">
				       and provider_discount = #{providerDiscount,jdbcType=DECIMAL}
				    </if>
				    <if test="dealCount != null and dealCount != ''">
				       and deal_count = #{dealCount,jdbcType=INTEGER}
				    </if>
				    <if test="callbackUrl != null and callbackUrl != ''">
				       and callback_url = #{callbackUrl,jdbcType=VARCHAR}
				    </if>
				    <if test="callbackStatus != null and callbackStatus != ''">
				       and callback_status = #{callbackStatus,jdbcType=CHAR}
				    </if>
				    <if test="applyDate != null and applyDate != ''">
				       and apply_date &gt;= #{applyDate,jdbcType=TIMESTAMP}
				    </if>
				    <if test="endDate != null and endDate != ''">
				       and apply_date &lt; #{endDate,jdbcType=TIMESTAMP}
				    </if>
				    <if test="(applyDate == null or applyDate == '') and (endDate == null or endDate == '')">
				       and apply_date &gt;= curdate()
				    </if>
	    		order by apply_date desc, create_date desc 
	    		<if test="beginNum != null and pageSize != null">
	    		limit 
	    			#{beginNum,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
			    </if>
	    	) pkTable 
	    left join mp_order a on pkTable.id = a.id
	    left join mp_phone_section ps on left(a.phone,7) = ps.section
	    left join mp_agent b on a.agent_id = b.id
	    where 
	    	1 = 1
		    <if test="channelPerson != null and channelPerson != ''" >
		       and b.channel_person = #{channelPerson,jdbcType=VARCHAR}
		    </if>
		    <if test="provinceCode != null and provinceCode != ''">
		       and ps.province_code like concat('%',#{provinceCode,jdbcType=VARCHAR},'%')
		    </if>
  </select>
  
  <sql id="exportCsvWhere">
  	<if test="applyDate != null and applyDate != ''">
		AND o.apply_date &gt;= #{applyDate,jdbcType = VARCHAR}
	</if>
	<if test="endDate != null and endDate != ''">
		AND o.apply_date &lt; #{endDate,jdbcType = VARCHAR}
	</if>
	<if test="agentParentId != null and agentParentId != ''" >
    	AND o.agent_id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId})
    </if>
	<if test="agentId != null and agentId != ''">
		AND o.agent_id = #{agentId,jdbcType = VARCHAR}
	</if>
	<if test="dispatcherProviderId != null and dispatcherProviderId != ''">
		AND o.dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR}
	</if>
	<if test="providerId != null and providerId != ''">
		AND o.provider_id = #{providerId,jdbcType=VARCHAR}
	</if>
	<if test="phone != null and phone != ''">
		AND o.phone = #{phone,jdbcType = VARCHAR}
	</if>
	<if test="orderId != null and orderId != ''">
		AND o.order_id = #{orderId,jdbcType = VARCHAR}
	</if>
	<if test="status != null and status != ''">
		AND o.status = #{status,jdbcType = VARCHAR}
	</if>
	<if test="provinceCode != null and provinceCode != ''">
		AND s.province_code = #{provinceCode,jdbcType = VARCHAR}
	</if>
  </sql>
  
  <select id="countDetailOrderList" resultType="java.lang.Integer">
  	SELECT
		count(1)
	FROM
		mp_order a
	LEFT JOIN mp_agent_bill_discount b ON a.agent_discount_id = b.id
	LEFT JOIN mp_provider_physical_channel c ON a.dispatcher_provider_id = c.id
	LEFT JOIN mp_phone_section d on LEFT(a.phone,7) = d.section
	LEFT JOIN mp_bill_pkg e ON a.pkg_id = e.id
	LEFT JOIN mp_agent f ON a.agent_id = f.id
	WHERE 1 = 1
	<if test="dispatcherProviderId != null and dispatcherProviderId != ''">
		AND a.dispatcher_provider_id = #{dispatcherProviderId,jdbcType = VARCHAR}
	</if>
	<if test="providerId != null and providerId != ''">
		AND a.provider_id = #{providerId,jdbcType = VARCHAR}
	</if>
	<if test="orderId != null and orderId != ''">
		AND a.order_id = #{orderId,jdbcType = VARCHAR}
	</if>
	<if test="phone != null and phone != ''">
		AND a.phone = #{phone,jdbcType = VARCHAR}
	</if>
	<if test="status != null and status != ''">
		AND a.status = #{status,jdbcType = VARCHAR}
	</if>
	<if test="provinceCode != null and provinceCode != ''">
		AND b.province_code = #{provinceCode,jdbcType = VARCHAR}
	</if>
	<if test="agentId != null and agentId != ''">
		AND a.agent_id = #{agentId,jdbcType = VARCHAR}
	</if>
	<if test="agentName != null and agentName != ''">
		AND f.name = #{agentName,jdbcType = VARCHAR}
	</if>
	<if test="channelName != null and channelName != ''">
		AND c.name like concat(concat('%',#{channelName,jdbcType = VARCHAR}),'%')
	</if>
	<if test="startDate != null and startDate != ''">
		AND a.create_date &gt;= #{startDate,jdbcType = VARCHAR}
	</if>
	<if test="endDate != null and endDate != ''">
		AND a.create_date &lt; #{endDate,jdbcType = VARCHAR}
	</if>
  
  </select>
  <!-- 获取话费通道账单统计详情列表总数new -->
  <select id="countDetailOrderListExt" resultType="java.lang.Integer">
	select
		count(1)
	FROM
	 mp_order a 
	LEFT JOIN mp_provider_physical_channel b ON a.dispatcher_provider_id = b.id 
	LEFT JOIN mp_provider c ON a.provider_id = c.id 
	left join mp_phone_section d ON a.provider_id = d.provider_id and left(a.phone,7) = d.section
	left join mp_agent e on a.agent_id = e.id
	left join mp_bill_pkg f on a.pkg_id = f.id
	left join mp_provider_bill_discount g on a.provider_discount_id = g.id
	WHERE 
		1 = 1 
		<if test="applyDate != null and applyDate != ''">
			AND a.apply_date &gt;= #{applyDate,jdbcType = VARCHAR}
		</if>
		<if test="endDate != null and endDate != ''">
			AND a.apply_date &lt; #{endDate,jdbcType = VARCHAR}
		</if>
		<if test="agentId != null and agentId != ''">
			AND a.agent_id = #{agentId,jdbcType = VARCHAR}
		</if>
		<if test="channelName != null and channelName != ''">
			and (
				b.`name` like concat('%',#{channelName,jdbcType = VARCHAR},'%')
				or
				c.short_name like concat('%',#{channelName,jdbcType = VARCHAR},'%')
			)
		</if>
		<if test="physicalChannelName != null and physicalChannelName != ''">
			and b.`name` = #{physicalChannelName,jdbcType = VARCHAR}
		</if>
		<if test="agentName != null and agentName != ''">
			and e.`name` like concat('%',#{agentName,jdbcType = VARCHAR},'%')
		</if>
		<if test="phone != null and phone != ''">
			and a.phone like concat('%',#{phone,jdbcType = VARCHAR},'%')
		</if>
		<if test="orderId != null and orderId != ''">
			and a.order_id like concat('%',#{orderId,jdbcType = VARCHAR},'%')
		</if>
		<if test="status != null and status != ''">
			and a.status = #{status,jdbcType = VARCHAR}
		</if>
		<if test="province != null and province != ''">
			and d.province_code = #{province,jdbcType = VARCHAR}
		</if>
  </select>
  
  <select id="selectAll" resultType="java.util.Map">
    select 
    	a.id, a.order_id as orderId, a.agent_order_id as agentOrderId, 
    a.provider_order_id as providerOrderId,a.agent_id as agentId, 
    a.dispatcher_provider_id as dispatcherProviderId, 
    a.provider_id as providerId,a.pkg_id as pkgId, a.bill_type as billType,a.status, a.result_code as resultCode, 
   	a.phone, a.biz_type as bizType, a.fee,a.value, a.agent_discount_id as agentDiscountId, 
    a.agent_discount as agentDiscount, a.provider_discount_id as providerDiscountId, 
    a.provider_discount as providerDiscount, a.deal_count as dealCount, a.deal_path as dealPath,
    a.callback_url as callbackUrl,a.callback_status as callbackStatus,
   	date_format(a.apply_date, '%Y-%m-%d %H:%i:%s') as applyDate,
   	date_format(a.create_date, '%Y-%m-%d %H:%i:%s') as createDate,
    date_format(a.end_date, '%Y-%m-%d %H:%i:%s') as endDate,
	b.name AS agent,c.name AS dispatcherProvider,d.name as provider,
	b.channel_person,
	e.suName channelPerson,
	date_format(a.callback_date, '%Y-%m-%d %H:%i:%s') as callbackDate,
    a.consumed_time as consumedTime,ps.province_code as province
    from 
    	mp_order a 
    left join 
    	mp_provider_physical_channel c 
    on 
    	a.dispatcher_provider_id = c.id
    left join 
    	mp_phone_section ps
    on 
    	left(a.phone,7) = ps.section
    left join mp_agent b on a.agent_id = b.id
    left join sysusert e on b.channel_person = e.suId
    left join mp_provider d on a.provider_id = d.id 
    where 
    	1 = 1 and a.agent_id=b.id and a.provider_id = d.id
	    <if test="orderId != null and orderId != ''"  >
	       and a.order_id = #{orderId,jdbcType=VARCHAR}
	    </if>
	    <if test="agentOrderId != null and agentOrderId != ''">
	       and a.agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
	    </if>
	    <if test="agentParentId != null and agentParentId != ''" >
	       and a.agent_id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId})
	    </if>
	    <if test="channelPerson != null and channelPerson != ''" >
	       and agent_id in(select id from mp_agent where channel_person=#{channelPerson})
	    </if>
	    <if test="providerOrderId != null and providerOrderId != ''">
	       and a.provider_order_id = #{providerOrderId,jdbcType=VARCHAR}
	    </if>
	    <if test="agentId != null and agentId != ''" >
	       and a.agent_id = #{agentId,jdbcType=VARCHAR}
	    </if>
	    <if test="channelPerson != null and channelPerson != ''" >
	       and b.channel_person = #{channelPerson,jdbcType=VARCHAR}
	    </if>
	    <if test="dispatcherProviderId != null and dispatcherProviderId != ''">
	       and a.dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR}
	    </if>
	    <if test="providerId != null and providerId != ''">
	       and a.provider_id = #{providerId,jdbcType=VARCHAR}
	    </if>
	    <if test="pkgId != null and pkgId != ''">
	       and a.pkg_id = #{pkgId,jdbcType=VARCHAR}
	    </if>
	    <if test="billType != null and billType != ''">
	       and a.bill_type = #{billType,jdbcType=VARCHAR}
	    </if>
	    <if test="status != null and status != ''">
	       and a.status = #{status,jdbcType=VARCHAR}
	    </if>
	    <if test="resultCode != null and resultCode != ''">
	       and a.result_code = #{resultCode,jdbcType=VARCHAR}
	    </if>
	    <if test="phone != null and phone != ''">
	       and a.phone = #{phone,jdbcType=VARCHAR}
	    </if>
	    <if test="bizType != null and bizType != ''">
	       and a.biz_type = #{bizType,jdbcType=CHAR}
	    </if>
	    <if test="fee != null and fee != ''">
	       and a.fee = #{fee,jdbcType=DECIMAL}
	    </if>
	    <if test="value != null and value != ''">
	       and a.value = #{value,jdbcType=DECIMAL}
	    </if>
	    <if test="agentDiscountId != null and agentDiscountId != ''">
	       and a.agent_discount_id = #{agentDiscountId,jdbcType=VARCHAR}
	    </if>
	    <if test="agentDiscount != null and agentDiscount != ''">
	       and a.agent_discount = #{agentDiscount,jdbcType=DECIMAL}
	    </if>
	    <if test="providerDiscountId != null and providerDiscountId != ''">
	       and a.provider_discount_id = #{providerDiscountId,jdbcType=VARCHAR}
	    </if>
	    <if test="providerDiscount != null and providerDiscount != ''">
	       and a.provider_discount = #{providerDiscount,jdbcType=DECIMAL}
	    </if>
	    <if test="provinceCode != null and provinceCode != ''">
	       and ps.province_code like concat('%',#{provinceCode,jdbcType=VARCHAR},'%')
	    </if>
	    <if test="dealCount != null and dealCount != ''">
	       and a.deal_count = #{dealCount,jdbcType=INTEGER}
	    </if>
	    <if test="callbackUrl != null and callbackUrl != ''">
	       and a.callback_url = #{callbackUrl,jdbcType=VARCHAR}
	    </if>
	    <if test="callbackStatus != null and callbackStatus != ''">
	       and a.callback_status = #{callbackStatus,jdbcType=CHAR}
	    </if>
	    <if test="applyDate != null and applyDate != ''">
	       and a.apply_date &gt;= #{applyDate,jdbcType=TIMESTAMP}
	    </if>
	    <if test="endDate != null and endDate != ''">
	       and a.apply_date &lt; #{endDate,jdbcType=TIMESTAMP}
	    </if>
	    <if test="(applyDate == null or applyDate == '') and (endDate == null or endDate == '')">
	       and a.apply_date &gt;= curdate()
	    </if>
    order by a.apply_date desc
  </select>
  <select id="selectByQueryOrder" resultType="java.util.Map">
    select 
    	a.id, a.order_id as orderId, a.agent_order_id as agentOrderId, 
    a.provider_order_id as providerOrderId,a.agent_id as agentId, 
    a.dispatcher_provider_id as dispatcherProviderId, 
    a.provider_id as providerId,a.pkg_id as pkgId, a.bill_type as billType,a.status, a.result_code as resultCode, 
   	a.phone, a.biz_type as bizType, a.fee,a.value, a.agent_discount_id as agentDiscountId, 
    a.agent_discount as agentDiscount, a.provider_discount_id as providerDiscountId, 
    a.provider_discount as providerDiscount, a.deal_count as dealCount, a.deal_path as dealPath,
    a.callback_url as callbackUrl,a.callback_status as callbackStatus,
   	date_format(a.apply_date, '%Y-%m-%d %H:%i:%s') as applyDate,
   	date_format(a.create_date, '%Y-%m-%d %H:%i:%s') as createDate,
    date_format(a.end_date, '%Y-%m-%d %H:%i:%s') as endDate,
	b.name AS agent,c.name AS dispatcherProvider,d.name as provider,
	b.channel_person,
	e.suName channelPerson,
	date_format(a.callback_date, '%Y-%m-%d %H:%i:%s') as callbackDate,
    a.consumed_time as consumedTime,ps.province_code as province
    from 
    	mp_order a 
    left join 
    	mp_provider_physical_channel c 
    on 
    	a.dispatcher_provider_id = c.id
    left join 
    	mp_phone_section ps
    on 
    	left(a.phone,7) = ps.section
    left join mp_agent b on a.agent_id = b.id
    left join sysusert e on b.channel_person = e.suId
    left join mp_provider d on a.provider_id = d.id 
    where 
    	1 = 1 and a.agent_id=b.id and a.provider_id = d.id
	    <if test="orderId != null and orderId != ''"  >
	       and a.order_id = #{orderId,jdbcType=VARCHAR}
	    </if>
	    <if test="agentOrderId != null and agentOrderId != ''">
	       and a.agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
	    </if>
	    <if test="agentParentId != null and agentParentId != ''" >
	       and a.agent_id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId})
	    </if>
	    <if test="channelPerson != null and channelPerson != ''" >
	       and agent_id in(select id from mp_agent where channel_person=#{channelPerson})
	    </if>
	    <if test="providerOrderId != null and providerOrderId != ''">
	       and a.provider_order_id = #{providerOrderId,jdbcType=VARCHAR}
	    </if>
	    <if test="agentId != null and agentId != ''" >
	       and a.agent_id = #{agentId,jdbcType=VARCHAR}
	    </if>
	    <if test="channelPerson != null and channelPerson != ''" >
	       and b.channel_person = #{channelPerson,jdbcType=VARCHAR}
	    </if>
	    <if test="dispatcherProviderId != null and dispatcherProviderId != ''">
	       and a.dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR}
	    </if>
	    <if test="providerId != null and providerId != ''">
	       and a.provider_id = #{providerId,jdbcType=VARCHAR}
	    </if>
	    <if test="pkgId != null and pkgId != ''">
	       and a.pkg_id = #{pkgId,jdbcType=VARCHAR}
	    </if>
	    <if test="billType != null and billType != ''">
	       and a.bill_type = #{billType,jdbcType=VARCHAR}
	    </if>
	    <if test="status != null and status != ''">
	       and a.status = #{status,jdbcType=VARCHAR}
	    </if>
	    <if test="resultCode != null and resultCode != ''">
	       and a.result_code = #{resultCode,jdbcType=VARCHAR}
	    </if>
	    <if test="phone != null and phone != ''">
	       and a.phone = #{phone,jdbcType=VARCHAR}
	    </if>
	    <if test="bizType != null and bizType != ''">
	       and a.biz_type = #{bizType,jdbcType=CHAR}
	    </if>
	    <if test="fee != null and fee != ''">
	       and a.fee = #{fee,jdbcType=DECIMAL}
	    </if>
	    <if test="value != null and value != ''">
	       and a.value = #{value,jdbcType=DECIMAL}
	    </if>
	    <if test="agentDiscountId != null and agentDiscountId != ''">
	       and a.agent_discount_id = #{agentDiscountId,jdbcType=VARCHAR}
	    </if>
	    <if test="agentDiscount != null and agentDiscount != ''">
	       and a.agent_discount = #{agentDiscount,jdbcType=DECIMAL}
	    </if>
	    <if test="providerDiscountId != null and providerDiscountId != ''">
	       and a.provider_discount_id = #{providerDiscountId,jdbcType=VARCHAR}
	    </if>
	    <if test="providerDiscount != null and providerDiscount != ''">
	       and a.provider_discount = #{providerDiscount,jdbcType=DECIMAL}
	    </if>
	    <if test="provinceCode != null and provinceCode != ''">
	       and ps.province_code like concat('%',#{provinceCode,jdbcType=VARCHAR},'%')
	    </if>
	    <if test="dealCount != null and dealCount != ''">
	       and a.deal_count = #{dealCount,jdbcType=INTEGER}
	    </if>
	    <if test="callbackUrl != null and callbackUrl != ''">
	       and a.callback_url = #{callbackUrl,jdbcType=VARCHAR}
	    </if>
	    <if test="callbackStatus != null and callbackStatus != ''">
	       and a.callback_status = #{callbackStatus,jdbcType=CHAR}
	    </if>
	    <if test="applyDate != null and applyDate != ''">
	       and a.apply_date &gt;= #{applyDate,jdbcType=TIMESTAMP}
	    </if>
	    <if test="endDate != null and endDate != ''">
	       and a.apply_date &lt; #{endDate,jdbcType=TIMESTAMP}
	    </if>
    order by a.apply_date desc
  </select>
  <select id="selectAllByPage" resultType="java.util.Map">
    select 
    	a.id, a.order_id as orderId, a.agent_order_id as agentOrderId, 
    a.provider_order_id as providerOrderId,a.agent_id as agentId, 
    a.dispatcher_provider_id as dispatcherProviderId, 
    a.provider_id as providerId,a.pkg_id as pkgId, a.bill_type as billType,a.status, a.result_code as resultCode, 
   	a.phone, a.biz_type as bizType, a.fee,a.value, a.agent_discount_id as agentDiscountId, 
    a.agent_discount as agentDiscount, a.provider_discount_id as providerDiscountId, 
    a.provider_discount as providerDiscount, a.deal_count as dealCount, a.deal_path as dealPath,
    a.callback_url as callbackUrl,a.callback_status as callbackStatus,
   	date_format(a.apply_date, '%Y-%m-%d %H:%i:%s') as applyDate,
   	date_format(a.create_date, '%Y-%m-%d %H:%i:%s') as createDate,
    date_format(a.end_date, '%Y-%m-%d %H:%i:%s') as endDate,
	b.name AS agent,c.name AS dispatcherProvider,d.name as provider,
	b.channel_person,
	e.suName channelPerson,
	date_format(a.callback_date, '%Y-%m-%d %H:%i:%s') as callbackDate,
    a.consumed_time as consumedTime,ps.province_code as province
    from 
    	(
    		select id from mp_order
    		where 1 = 1
    			<if test="orderId != null and orderId != ''"  >
			       and order_id = #{orderId,jdbcType=VARCHAR}
			    </if>
			    <if test="agentOrderId != null and agentOrderId != ''">
			       and agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
			    </if>
			    <if test="agentParentId != null and agentParentId != ''" >
			       and agent_id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId})
			    </if>
			    <if test="channelPerson != null and channelPerson != ''" >
			       and agent_id in(select id from mp_agent where channel_person=#{channelPerson})
			    </if>
			    <if test="providerOrderId != null and providerOrderId != ''">
			       and provider_order_id = #{providerOrderId,jdbcType=VARCHAR}
			    </if>
			    <if test="agentId != null and agentId != ''" >
			       and agent_id = #{agentId,jdbcType=VARCHAR}
			    </if>
			    <if test="dispatcherProviderId != null and dispatcherProviderId != ''">
			       and dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR}
			    </if>
			    <if test="providerId != null and providerId != ''">
			       and provider_id = #{providerId,jdbcType=VARCHAR}
			    </if>
			    <if test="pkgId != null and pkgId != ''">
			       and pkg_id = #{pkgId,jdbcType=VARCHAR}
			    </if>
			    <if test="billType != null and billType != ''">
			       and bill_type = #{billType,jdbcType=VARCHAR}
			    </if>
			    <if test="status != null and status != ''">
			       and status = #{status,jdbcType=VARCHAR}
			    </if>
			    <if test="resultCode != null and resultCode != ''">
			       and result_code = #{resultCode,jdbcType=VARCHAR}
			    </if>
			    <if test="phone != null and phone != ''">
			       and phone = #{phone,jdbcType=VARCHAR}
			    </if>
			    <if test="bizType != null and bizType != ''">
			       and biz_type = #{bizType,jdbcType=CHAR}
			    </if>
			    <if test="fee != null and fee != ''">
			       and fee = #{fee,jdbcType=DECIMAL}
			    </if>
			    <if test="value != null and value != ''">
			       and value = #{value,jdbcType=DECIMAL}
			    </if>
			    <if test="agentDiscountId != null and agentDiscountId != ''">
			       and agent_discount_id = #{agentDiscountId,jdbcType=VARCHAR}
			    </if>
			    <if test="agentDiscount != null and agentDiscount != ''">
			       and agent_discount = #{agentDiscount,jdbcType=DECIMAL}
			    </if>
			    <if test="providerDiscountId != null and providerDiscountId != ''">
			       and provider_discount_id = #{providerDiscountId,jdbcType=VARCHAR}
			    </if>
			    <if test="providerDiscount != null and providerDiscount != ''">
			       and provider_discount = #{providerDiscount,jdbcType=DECIMAL}
			    </if>
			    <if test="dealCount != null and dealCount != ''">
			       and deal_count = #{dealCount,jdbcType=INTEGER}
			    </if>
			    <if test="callbackUrl != null and callbackUrl != ''">
			       and callback_url = #{callbackUrl,jdbcType=VARCHAR}
			    </if>
			    <if test="callbackStatus != null and callbackStatus != ''">
			       and callback_status = #{callbackStatus,jdbcType=CHAR}
			    </if>
			    <if test="applyDate != null and applyDate != ''">
			       and apply_date &gt;= #{applyDate,jdbcType=TIMESTAMP}
			    </if>
			    <if test="endDate != null and endDate != ''">
			       and apply_date &lt; #{endDate,jdbcType=TIMESTAMP}
			    </if>
			    <if test="(applyDate == null or applyDate == '') and (endDate == null or endDate == '')">
			       and apply_date &gt;= curdate()
			    </if>
    		order by apply_date desc, create_date desc 
    		<if test="beginNum != null and pageSize != null">
    		limit 
    			#{beginNum,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
		    </if>
    	) pkTable 
    left join mp_order a on pkTable.id = a.id
    left join mp_provider_physical_channel c on a.dispatcher_provider_id = c.id
    left join mp_phone_section ps on left(a.phone,7) = ps.section
    left join mp_agent b on a.agent_id = b.id
    left join sysusert e on b.channel_person = e.suId
    left join mp_provider d on a.provider_id = d.id 
    where 
    	1 = 1 and a.agent_id=b.id and a.provider_id = d.id
	    <if test="channelPerson != null and channelPerson != ''" >
	       and b.channel_person = #{channelPerson,jdbcType=VARCHAR}
	    </if>
	    <if test="provinceCode != null and provinceCode != ''">
	       and ps.province_code like concat('%',#{provinceCode,jdbcType=VARCHAR},'%')
	    </if>
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from mp_order
    where id = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="java.util.Map">
    
    insert into mp_order (id, order_id, agent_order_id, 
      provider_order_id, agent_id, dispatcher_provider_id, 
      provider_id, pkg_id, bill_type, status, result_code, 
      phone, biz_type, fee, value, agent_discount_id, agent_discount,
      provider_discount_id, provider_discount,
      deal_count, deal_path, callback_url, callback_status, 
      apply_date, create_date, end_date)
    values (#{id,jdbcType=VARCHAR}, #{orderId,jdbcType=VARCHAR}, #{agentOrderId,jdbcType=VARCHAR}, 
      #{providerOrderId,jdbcType=VARCHAR}, #{agentId,jdbcType=VARCHAR}, #{dispatcherProviderId,jdbcType=VARCHAR}, 
      #{providerId,jdbcType=VARCHAR}, #{pkgId,jdbcType=VARCHAR}, #{billType,jdbcType=VARCHAR}, #{status,jdbcType=VARCHAR}, #{resultCode,jdbcType=VARCHAR}, 
      #{phone,jdbcType=VARCHAR}, #{bizType,jdbcType=CHAR}, #{fee,jdbcType=DECIMAL}, #{value,jdbcType=DECIMAL}, 
      #{agentDiscountId,jdbcType=VARCHAR},#{agentDiscount,jdbcType=DECIMAL},#{providerDiscountId,jdbcType=VARCHAR},#{providerDiscount,jdbcType=DECIMAL},
      #{dealCount,jdbcType=INTEGER}, #{dealPath,jdbcType=VARCHAR}, #{callbackUrl,jdbcType=VARCHAR}, #{callbackStatus,jdbcType=CHAR}, 
      #{applyDate,jdbcType=TIMESTAMP}, now(), #{endDate,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="java.util.Map">
  
    insert into mp_order
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="orderId != null">
        order_id,
      </if>
      <if test="agentOrderId != null">
        agent_order_id,
      </if>
      <if test="providerOrderId != null">
        provider_order_id,
      </if>
      <if test="agentId != null">
        agent_id,
      </if>
      <if test="dispatcherProviderId != null">
        dispatcher_provider_id,
      </if>
      <if test="providerId != null">
        provider_id,
      </if>
      <if test="pkgId != null">
        pkg_id,
      </if>
      <if test="billType != null">
        bill_type,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="resultCode != null">
        result_code,
      </if>
      <if test="phone != null">
        phone,
      </if>
      <if test="bizType != null">
        biz_type,
      </if>
      <if test="fee != null">
        fee,
      </if>
      <if test="value != null">
        value,
      </if>
      <if test="agentDiscountId != null">
        agent_discount_id,
      </if>
      <if test="agentDiscount != null">
        agent_discount,
      </if>
      <if test="providerDiscountId != null">
        provider_discount_id,
      </if>
      <if test="providerDiscount != null">
        provider_discount,
      </if>
      <if test="dealCount != null">
        deal_count,
      </if>
      <if test="dealPath != null">
        deal_path,
      </if>
      <if test="callbackUrl != null">
        callback_url,
      </if>
      <if test="callbackStatus != null">
        callback_status,
      </if>
      <if test="applyDate != null">
        apply_date,
      </if>
      <if test="endDate != null">
        end_date,
      </if>
      create_date
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="orderId != null">
        #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="agentOrderId != null">
        #{agentOrderId,jdbcType=VARCHAR},
      </if>
      <if test="providerOrderId != null">
        #{providerOrderId,jdbcType=VARCHAR},
      </if>
      <if test="agentId != null">
        #{agentId,jdbcType=VARCHAR},
      </if>
      <if test="dispatcherProviderId != null">
        #{dispatcherProviderId,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null">
        #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="pkgId != null">
        #{pkgId,jdbcType=VARCHAR},
      </if>
      <if test="billType != null">
        #{billType,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        #{status,jdbcType=VARCHAR},
      </if>
      <if test="resultCode != null">
        #{resultCode,jdbcType=VARCHAR},
      </if>
      <if test="phone != null">
        #{phone,jdbcType=VARCHAR},
      </if>
      <if test="bizType != null">
        #{bizType,jdbcType=CHAR},
      </if>
      <if test="fee != null">
        #{fee,jdbcType=DECIMAL},
      </if>
      <if test="value != null">
        #{value,jdbcType=DECIMAL},
      </if>
      <if test="agentDiscountId != null">
	    #{agentDiscountId,jdbcType=VARCHAR},
	   </if>
	   <if test="agentDiscount != null">
	     #{agentDiscount,jdbcType=DECIMAL},
	   </if>
	   <if test="providerDiscountId != null">
	      #{providerDiscountId,jdbcType=VARCHAR},
	   </if>
	   <if test="providerDiscount != null">
	      #{providerDiscount,jdbcType=DECIMAL},
	   </if>
      <if test="dealCount != null">
        #{dealCount,jdbcType=INTEGER},
      </if>
      <if test="dealPath != null">
        #{dealPath,jdbcType=VARCHAR},
      </if>
      <if test="callbackUrl != null">
        #{callbackUrl,jdbcType=VARCHAR},
      </if>
      <if test="callbackStatus != null">
        #{callbackStatus,jdbcType=CHAR},
      </if>
      <if test="applyDate != null">
        #{applyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="endDate != null">
        #{endDate,jdbcType=TIMESTAMP},
      </if>
      now()
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update mp_order
    <set>
      <if test="orderId != null">
        order_id = #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="agentOrderId != null">
        agent_order_id = #{agentOrderId,jdbcType=VARCHAR},
      </if>
      <if test="providerOrderId != null">
        provider_order_id = #{providerOrderId,jdbcType=VARCHAR},
      </if>
      <if test="agentId != null">
        agent_id = #{agentId,jdbcType=VARCHAR},
      </if>
      <if test="dispatcherProviderId != null">
        dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null">
        provider_id = #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="pkgId != null">
        pkg_id = #{pkgId,jdbcType=VARCHAR},
     </if>
     <if test="billType != null">
        bill_type = #{billType,jdbcType=VARCHAR},
     </if>
      <if test="status != null">
        status = #{status,jdbcType=VARCHAR},
      </if>
      <if test="resultCode != null">
        result_code = #{resultCode,jdbcType=VARCHAR},
      </if>
      <if test="phone != null">
        phone = #{phone,jdbcType=VARCHAR},
      </if>
      <if test="bizType != null">
        biz_type = #{bizType,jdbcType=CHAR},
      </if>
      <if test="fee != null">
        fee = #{fee,jdbcType=DECIMAL},
      </if>
      <if test="value != null">
        value = #{value,jdbcType=DECIMAL},
      </if>
      <if test="agentDiscountId != null">
       agent_discount_id = #{agentDiscountId,jdbcType=VARCHAR},
    </if>
    <if test="agentDiscount != null">
       agent_discount = #{agentDiscount,jdbcType=DECIMAL},
    </if>
    <if test="providerDiscountId != null">
       provider_discount_id = #{providerDiscountId,jdbcType=VARCHAR},
    </if>
    <if test="providerDiscount != null">
       provider_discount = #{providerDiscount,jdbcType=DECIMAL},
    </if>
      <if test="dealCount != null">
        deal_count = #{dealCount,jdbcType=INTEGER},
      </if>
      <if test="dealPath != null">
        deal_path = #{dealPath,jdbcType=VARCHAR},
      </if>
      <if test="callbackUrl != null">
        callback_url = #{callbackUrl,jdbcType=VARCHAR},
      </if>
      <if test="callbackStatus != null">
        callback_status = #{callbackStatus,jdbcType=CHAR},
      </if>
      <if test="applyDate != null">
        apply_date = #{applyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createDate != null">
        create_date = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="endDate != null">
        end_date = #{endDate,jdbcType=TIMESTAMP},
      </if>
      <if test="callbackDate != null">
        callback_date = #{callbackDate,jdbcType=TIMESTAMP},
      </if>
      <if test="consumedTime != null">
      	consumed_time = #{consumedTime,jdbcType=INTEGER}
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
<!--   更新状态，避免查询与回调冲突 -->
  <update id="updateOrder" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update mp_order
    <set>
      <if test="orderId != null">
        order_id = #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="agentOrderId != null">
        agent_order_id = #{agentOrderId,jdbcType=VARCHAR},
      </if>
      <if test="providerOrderId != null">
        provider_order_id = #{providerOrderId,jdbcType=VARCHAR},
      </if>
      <if test="agentId != null">
        agent_id = #{agentId,jdbcType=VARCHAR},
      </if>
      <if test="dispatcherProviderId != null">
        dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null">
        provider_id = #{providerId,jdbcType=VARCHAR},
      </if>
       <if test="pkgId != null">
        pkg_id = #{pkgId,jdbcType=VARCHAR},
       </if>
     <if test="billType != null">
        bill_type = #{billType,jdbcType=VARCHAR},
     </if>
      <if test="status != null">
        status = #{status,jdbcType=VARCHAR},
      </if>
      <if test="resultCode != null">
        result_code = #{resultCode,jdbcType=VARCHAR},
      </if>
      <if test="phone != null">
        phone = #{phone,jdbcType=VARCHAR},
      </if>
      <if test="bizType != null">
        biz_type = #{bizType,jdbcType=CHAR},
      </if>
      <if test="fee != null">
        fee = #{fee,jdbcType=DECIMAL},
      </if>
      <if test="value != null">
        value = #{value,jdbcType=DECIMAL},
      </if>
      <if test="agentDiscountId != null">
        agent_discount_id = #{agentDiscountId,jdbcType=VARCHAR},
      </if>
      <if test="agentDiscount != null">
        agent_discount = #{agentDiscount,jdbcType=DECIMAL},
      </if>
      <if test="providerDiscountId != null">
        provider_discount_id = #{providerDiscountId,jdbcType=VARCHAR},
      </if>
      <if test="providerDiscount != null">
        provider_discount = #{providerDiscount,jdbcType=DECIMAL},
      </if>
      <if test="dealCount != null">
        deal_count = #{dealCount,jdbcType=INTEGER},
      </if>
      <if test="dealPath != null">
        deal_path = #{dealPath,jdbcType=VARCHAR},
      </if>
      <if test="callbackUrl != null">
        callback_url = #{callbackUrl,jdbcType=VARCHAR},
      </if>
      <if test="callbackStatus != null">
        callback_status = #{callbackStatus,jdbcType=CHAR},
      </if>
      <if test="applyDate != null">
        apply_date = #{applyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createDate != null">
        create_date = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="endDate != null">
        end_date = #{endDate,jdbcType=TIMESTAMP},
      </if>
      <if test="callbackDate != null">
        callback_date = #{callbackDate,jdbcType=TIMESTAMP},
      </if>
      <if test="consumedTime != null">
      	consumed_time = #{consumedTime,jdbcType=INTEGER}
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR} and status = 1
  </update>
  
  <update id="updateOrderByFail" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update mp_order
    <set>
      <if test="orderId != null">
        order_id = #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="agentOrderId != null">
        agent_order_id = #{agentOrderId,jdbcType=VARCHAR},
      </if>
      <if test="providerOrderId != null">
        provider_order_id = #{providerOrderId,jdbcType=VARCHAR},
      </if>
      <if test="agentId != null">
        agent_id = #{agentId,jdbcType=VARCHAR},
      </if>
      <if test="dispatcherProviderId != null">
        dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null">
        provider_id = #{providerId,jdbcType=VARCHAR},
      </if>
       <if test="pkgId != null">
        pkg_id = #{pkgId,jdbcType=VARCHAR},
       </if>
     <if test="billType != null">
        bill_type = #{billType,jdbcType=VARCHAR},
     </if>
      <if test="status != null">
        status = #{status,jdbcType=VARCHAR},
      </if>
      <if test="resultCode != null">
        result_code = #{resultCode,jdbcType=VARCHAR},
      </if>
      <if test="phone != null">
        phone = #{phone,jdbcType=VARCHAR},
      </if>
      <if test="bizType != null">
        biz_type = #{bizType,jdbcType=CHAR},
      </if>
      <if test="fee != null">
        fee = #{fee,jdbcType=DECIMAL},
      </if>
      <if test="value != null">
        value = #{value,jdbcType=DECIMAL},
      </if>
      <if test="agentDiscountId != null">
        agent_discount_id = #{agentDiscountId,jdbcType=VARCHAR},
      </if>
      <if test="agentDiscount != null">
        agent_discount = #{agentDiscount,jdbcType=DECIMAL},
      </if>
      <if test="providerDiscountId != null">
        provider_discount_id = #{providerDiscountId,jdbcType=VARCHAR},
      </if>
      <if test="providerDiscount != null">
        provider_discount = #{providerDiscount,jdbcType=DECIMAL},
      </if>
      <if test="dealCount != null">
        deal_count = #{dealCount,jdbcType=INTEGER},
      </if>
      <if test="dealPath != null">
        deal_path = #{dealPath,jdbcType=VARCHAR},
      </if>
      <if test="callbackUrl != null">
        callback_url = #{callbackUrl,jdbcType=VARCHAR},
      </if>
      <if test="callbackStatus != null">
        callback_status = #{callbackStatus,jdbcType=CHAR},
      </if>
      <if test="applyDate != null">
        apply_date = #{applyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createDate != null">
        create_date = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="endDate != null">
        end_date = #{endDate,jdbcType=TIMESTAMP},
      </if>
      <if test="callbackDate != null">
        callback_date = #{callbackDate,jdbcType=TIMESTAMP},
      </if>
      <if test="consumedTime != null">
      	consumed_time = #{consumedTime,jdbcType=INTEGER}
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
  
  <select id="selectByOrderId" parameterType="java.lang.String" resultType="java.util.Map">
    select 
    <include refid="Base_Column_List_For_OrderId" />
    from mp_order
    where order_id = #{orderId,jdbcType=VARCHAR}
  </select>
  <select id="selectByAgentOrderId" parameterType="java.lang.String" resultType="java.util.Map">
    select 
    <include refid="Base_Column_List_For_OrderId" />
    from mp_order
    where agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
  </select>
  <select id="selectByProviderOrderId" parameterType="java.lang.String" resultType="java.util.Map">
    select 
    <include refid="Base_Column_List_For_OrderId" />
    from mp_order
    where provider_order_id = #{providerOrderId,jdbcType=VARCHAR}
  </select>
  <select id="selectById" parameterType="java.lang.String" resultType="java.util.Map">
    select 
    <include refid="Base_Column_List_For_OrderId" />
    from mp_order
    where id = #{id,jdbcType=VARCHAR}
  </select>
  <sql id="myWhere">
	<if test="orderId != null and orderId != ''"  >
       and a.order_id = #{orderId,jdbcType=VARCHAR}
    </if>
    <if test="agentOrderId != null and agentOrderId != ''">
       and a.agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
    </if>
    <if test="providerOrderId != null and providerOrderId != ''">
       and a.provider_order_id = #{providerOrderId,jdbcType=VARCHAR}
    </if>
    <if test="agentId != null and agentId != ''" >
       and a.agent_id = #{agentId,jdbcType=VARCHAR}
    </if>
    <if test="dispatcherProviderId != null and dispatcherProviderId != ''">
       and a.dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR}
    </if>
    <if test="providerId != null and providerId != ''">
       and a.provider_id = #{providerId,jdbcType=VARCHAR}
    </if>
    <if test="pkgId != null">
       and a.pkg_id = #{pkgId,jdbcType=VARCHAR}
    </if>
    <if test="billType != null">
       and a.bill_type = #{billType,jdbcType=VARCHAR}
    </if>
    <if test="status != null and status != ''">
       and a.status = #{status,jdbcType=VARCHAR}
    </if>
    <if test="resultCode != null and resultCode != ''">
       and a.result_code = #{resultCode,jdbcType=VARCHAR}
    </if>
    <if test="phone != null and phone != ''">
       and a.phone = #{phone,jdbcType=VARCHAR}
    </if>
    <if test="bizType != null and bizType != ''">
       and a.biz_type = #{bizType,jdbcType=CHAR}
    </if>
    <if test="fee != null and fee != ''">
       and a.fee = #{fee,jdbcType=DECIMAL}
    </if>
    <if test="value != null and value != ''">
       and a.value = #{value,jdbcType=DECIMAL}
    </if>
    <if test="agentDiscountId != null">
       and a.agent_discount_id = #{agentDiscountId,jdbcType=VARCHAR}
    </if>
    <if test="agentDiscount != null">
       and a.agent_discount = #{agentDiscount,jdbcType=DECIMAL}
    </if>
    <if test="providerDiscountId != null">
       and a.provider_discount_id = #{providerDiscountId,jdbcType=VARCHAR}
    </if>
    <if test="providerDiscount != null">
       and a.provider_discount = #{providerDiscount,jdbcType=DECIMAL}
    </if>
    <if test="dealCount != null and dealCount != ''">
       and a.deal_count = #{dealCount,jdbcType=INTEGER}
    </if>
    <if test="callbackUrl != null and callbackUrl != ''">
       and a.callback_url = #{callbackUrl,jdbcType=VARCHAR}
    </if>
    <if test="callbackStatus != null and callbackStatus != ''">
       and a.callback_status = #{callbackStatus,jdbcType=CHAR}
    </if>
    <if test="applyDate1 != nulland applyDate2 != null ">
       and a.apply_date BETWEEN #{applyDate1,jdbcType=TIMESTAMP} and #{applyDate2,jdbcType=TIMESTAMP}
    </if>
    <if test="endDate1 != null and endDate2 != null ">
       and a.end_date BETWEEN #{endDate1,jdbcType=TIMESTAMP} and #{endDate2,jdbcType=TIMESTAMP}
    </if>
    </sql>
    
    <select id="selectOrderByBizTypeAndApplyDate" resultType="java.util.Map">
	    select 
	    	a.apply_date applyDate,a.end_date endDate,a.order_id orderId,a.provider_order_id providerOrderId,
	    	a.agent_order_id agentOrderId,d.name providerName,c.name providerPhysicalChannel,
			a.provider_discount as providerDiscount,a.phone,a.`status`,a.fee,a.`value`,b.`name` agentName,
			f.name pkgName,a.agent_discount agentDiscount,ps.province_code provinceCode 
	    from 
	    	(
	    		select id from mp_order
	    		where 1 = 1
	    			<if test="orderId != null and orderId != ''"  >
				       and order_id = #{orderId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentOrderId != null and agentOrderId != ''">
				       and agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentParentId != null and agentParentId != ''" >
				       and agent_id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId})
				    </if>
				    <if test="channelPerson != null and channelPerson != ''" >
				       and agent_id in(select id from mp_agent where channel_person=#{channelPerson})
				    </if>
				    <if test="providerOrderId != null and providerOrderId != ''">
				       and provider_order_id = #{providerOrderId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentId != null and agentId != ''" >
				       and agent_id = #{agentId,jdbcType=VARCHAR}
				    </if>
				    <if test="dispatcherProviderId != null and dispatcherProviderId != ''">
				       and dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR}
				    </if>
				    <if test="providerId != null and providerId != ''">
				       and provider_id = #{providerId,jdbcType=VARCHAR}
				    </if>
				    <if test="pkgId != null and pkgId != ''">
				       and pkg_id = #{pkgId,jdbcType=VARCHAR}
				    </if>
				    <if test="billType != null and billType != ''">
				       and bill_type = #{billType,jdbcType=VARCHAR}
				    </if>
				    <if test="status != null and status != ''">
				       and status = #{status,jdbcType=VARCHAR}
				    </if>
				    <if test="resultCode != null and resultCode != ''">
				       and result_code = #{resultCode,jdbcType=VARCHAR}
				    </if>
				    <if test="phone != null and phone != ''">
				       and phone = #{phone,jdbcType=VARCHAR}
				    </if>
				    <if test="bizType != null and bizType != ''">
				       and biz_type = #{bizType,jdbcType=CHAR}
				    </if>
				    <if test="fee != null and fee != ''">
				       and fee = #{fee,jdbcType=DECIMAL}
				    </if>
				    <if test="value != null and value != ''">
				       and value = #{value,jdbcType=DECIMAL}
				    </if>
				    <if test="agentDiscountId != null and agentDiscountId != ''">
				       and agent_discount_id = #{agentDiscountId,jdbcType=VARCHAR}
				    </if>
				    <if test="agentDiscount != null and agentDiscount != ''">
				       and agent_discount = #{agentDiscount,jdbcType=DECIMAL}
				    </if>
				    <if test="providerDiscountId != null and providerDiscountId != ''">
				       and provider_discount_id = #{providerDiscountId,jdbcType=VARCHAR}
				    </if>
				    <if test="providerDiscount != null and providerDiscount != ''">
				       and provider_discount = #{providerDiscount,jdbcType=DECIMAL}
				    </if>
				    <if test="dealCount != null and dealCount != ''">
				       and deal_count = #{dealCount,jdbcType=INTEGER}
				    </if>
				    <if test="callbackUrl != null and callbackUrl != ''">
				       and callback_url = #{callbackUrl,jdbcType=VARCHAR}
				    </if>
				    <if test="callbackStatus != null and callbackStatus != ''">
				       and callback_status = #{callbackStatus,jdbcType=CHAR}
				    </if>
				    <if test="applyDate != null and applyDate != ''">
				       and apply_date &gt;= #{applyDate,jdbcType=TIMESTAMP}
				    </if>
				    <if test="endDate != null and endDate != ''">
				       and apply_date &lt; #{endDate,jdbcType=TIMESTAMP}
				    </if>
				    <if test="(applyDate == null or applyDate == '') and (endDate == null or endDate == '')">
				       and apply_date &gt;= curdate()
				    </if>
	    		order by apply_date desc, create_date desc 
	    		<if test="beginNum != null and pageSize != null">
	    		limit 
	    			#{beginNum,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
			    </if>
	    	) pkTable 
	    left join mp_order a on pkTable.id = a.id
	    left join mp_provider_physical_channel c on a.dispatcher_provider_id = c.id
	    left join mp_phone_section ps on left(a.phone,7) = ps.section
	    left join mp_agent b on a.agent_id = b.id
	    left join sysusert e on b.channel_person = e.suId
	    left join mp_provider d on a.provider_id = d.id 
	    left join mp_bill_pkg f on a.pkg_id = f.id
	    where 
	    	1 = 1 and a.agent_id=b.id and a.provider_id = d.id
		    <if test="channelPerson != null and channelPerson != ''" >
		       and b.channel_person = #{channelPerson,jdbcType=VARCHAR}
		    </if>
		    <if test="provinceCode != null and provinceCode != ''">
		       and ps.province_code like concat('%',#{provinceCode,jdbcType=VARCHAR},'%')
		    </if>
  	</select>
  	
  	<!-- 查询订单参数详情 -->
    <select id="selectOrderParam" resultType="java.util.Map">
		select 
			a.order_id as orderId,a.agent_order_id as agentOrderId,
			a.provider_id as providerId,a.bill_type as billType,
			a.phone,a.fee,`value`,b.province_code as provinceCode,
			a.pkg_id as pkgId,a.agent_discount as agentDiscount,
			b.city_code as cityCode,c.`name` as providerName,d.id as agentId,
			d.`name` as agentName,e.`name` as groupName,
			case when count(f.id) > 0 then '是' else '否' end yesOrNo
		from 
		  mp_order a
		left join 
			mp_phone_section b
		on 
			substr(a.phone,1,7) = b.section
		left join 
			mp_provider c
		on 
			b.provider_id = c.id
		left join 
			mp_agent d
		on 
			a.agent_id = d.id
		left join 
			mp_provider_bill_group e
		on 
			d.bill_group_id = e.id
		left join 
			mp_provider_group_bill_rel f
		on 
			a.provider_id = f.provider_id and d.bill_group_id = f.group_id and (b.province_code = f.province_code or f.province_code = '全国')
		where 1=1 
		<if test="agentOrderId != null and agentOrderId != ''">
			and a.agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
		</if>
		<if test="phone != null and phone != ''">
			and a.phone = #{phone,jdbcType=VARCHAR}
		</if>
		<if test="agentParentId != null and agentParentId != ''" >
	       and a.agent_id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId})
	    </if>
  	</select>
  	
    <select id="selectFastNewOrderByPhone" resultType="java.util.Map">
		select * from mp_order where 1=1
		<if test="agentOrderId != null and agentOrderId != ''">
			and agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
		</if>
		<if test="phone != null and phone != ''">
			and phone = #{phone,jdbcType=VARCHAR}
		</if>
		<if test="agentParentId != null and agentParentId != ''" >
	       and agent_id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId})
	    </if>
		order by apply_date desc limit 1
  	</select>
  	
<!--   	<select id="selectAgentChartsData" resultType="java.lang.String"> -->
<!-- 		SELECT -->
<!-- 			IFNULL(count(1),0) as count -->
<!-- 		FROM -->
<!-- 			mp_order -->
<!-- 		WHERE -->
<!-- 			DATE_FORMAT(apply_date, '%Y-%m-%d') IN  -->
<!-- 		<foreach collection="dateList" item="date" separator="," open="(" close=")"> -->
<!-- 			#{date,jdbcType=VARCHAR} -->
<!-- 		</foreach> -->
<!-- 		<if test="agentId != null and agentId != ''"> -->
<!-- 			and agent_id = #{agentId,jdbcType=VARCHAR} -->
<!-- 		</if> -->
<!-- 		GROUP BY -->
<!-- 			DATE_FORMAT(apply_date, '%Y-%m-%d') -->
<!--   	</select> -->
  	<select id="selectForntDate" resultType="java.lang.String">
  		SELECT * FROM (
  		SELECT
			DATE_FORMAT(apply_date, '%Y-%m-%d') days
		FROM
			mp_order
		WHERE 1 = 1
		<if test="agentId != null and agentId != ''">
			and agent_id = #{agentId,jdbcType=VARCHAR}
		</if>
		GROUP BY
			days
		ORDER BY
			days DESC
		LIMIT 0,7) a ORDER BY a.days ASC
  	</select>
  	
	<!-- 查询千米供货平台
		充值已经成功或者失败,
		回调推送没有成功,
		且充值状态改变已经超过5分钟,不超过一星期的订单 -->
  	<select id="selectGongHuoPingTaiOrder" resultType="java.util.Map">
  		select 
  			* 
  		from 
  			mp_order
   		where 
   			(
   				end_date BETWEEN date_sub(now(),interval 7 day) and date_sub(now(),interval 5 minute)
			)
   			and `status` in('3','4') 
   			and callback_status = '0' 
   			and agent_order_id like concat(#{ptId,jdbcType=VARCHAR},'%',#{ptId,jdbcType=VARCHAR}) 
			order by end_date desc
  	</select>
  	<select id="checkAgentOrderId" resultType="java.lang.Integer">
<!--   		SELECT COUNT(1) from mp_order where agent_order_id = #{agentOrderId,jdbcType=VARCHAR}; -->
  		SELECT (SELECT COUNT(1) from mp_order where agent_order_id =  #{agentOrderId,jdbcType=VARCHAR}) + (SELECT COUNT(1) from mp_exception_order where agent_order_id =  #{agentOrderId,jdbcType=VARCHAR});
  	</select>
  	
  	<select id="selectDispatcherProvider" resultType="java.util.Map">
  		select 
  			dispatcher_provider_id 
  		from
  			mp_order 
  		where
  			apply_date &gt; #{startDate,jdbcType=VARCHAR}
  			and apply_date &lt; #{endDate,jdbcType=VARCHAR}
  			and `status`='3' 
  		group by
  			dispatcher_provider_id;
  	</select>
  	
  	<select id="checkPhone" resultType="java.lang.Integer">
  		SELECT COUNT(1) from mp_order where 
  			phone = #{phoneNo,jdbcType=VARCHAR}
  			and `status` = '3'
  			and fee = #{fee,jdbcType=INTEGER}
  			and apply_date > SUBDATE(now(),interval 1 minute);
  	</select>
</mapper>