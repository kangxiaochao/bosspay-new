<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hyfd.dao.mp.ProviderBillDiscountDao">
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, provider_physical_channel_id as providerPhysicalChannelId, provider_id as providerId,
    name, discount, bill_pkg_id as billPkgId, province_code as provinceCode, 
    city_code as cityCode, update_date as updateDate, update_user as updateUser, 
    create_date as createDate, create_user as createUser
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from mp_provider_bill_discount
    where id = #{id,jdbcType=VARCHAR}
  </select>
  <!-- 	查询虚商折扣 -->
	<select id="selectChannelVpd" resultType="java.util.Map">
		select
		   distinct discount,real_discount
		from mp_provider_bill_discount a 
		where a.del_flag = 1
		<if test="physicalId != null and physicalId !='' ">
	      	and a.provider_physical_channel_id = #{physicalId,jdbcType=VARCHAR}
	    </if>
	     <if test="providerId != null and providerId !=''">
	       and a.provider_id = #{providerId,jdbcType=VARCHAR}
	    </if>
	     <if test="provinceCode != null and provinceCode !=''">
	       and a.province_code in('全国', #{provinceCode,jdbcType=VARCHAR})
	    </if>
	</select>
  <select id="selectCount" resultType="java.lang.Integer">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    	count(1)
    from mp_provider_bill_discount a LEFT JOIN mp_provider b on a.provider_id = b.id 
    where 
    	a.del_flag = 1 
	    <if test="providerPhysicalChannelId != null">
	       and a.provider_physical_channel_id = #{providerPhysicalChannelId,jdbcType=VARCHAR}
	    </if>
	    <if test="providerId != null">
	       and a.provider_id = #{providerId,jdbcType=VARCHAR}
	    </if>
	    <if test="name != null and name != '' ">
	       and a.name = like concat('%',#{name,jdbcType=VARCHAR},'%') 
	    </if>
	    <if test="discount != null">
	       and a.discount = #{discount,jdbcType=DECIMAL}
	    </if>
	    <if test="billPkgId != null">
	       and a.bill_pkg_id = #{billPkgId,jdbcType=VARCHAR}
	    </if>
	    <if test="provinceCode != null">
	       and a.province_code = #{provinceCode,jdbcType=VARCHAR}
	    </if>
	    <if test="cityCode != null">
	       and a.city_code = #{cityCode,jdbcType=VARCHAR}
	    </if>
	    <if test="updateDate != null">
	       and a.update_date = #{updateDate,jdbcType=TIMESTAMP}
	    </if>
	    <if test="updateUser != null">
	       and a.update_user = #{updateUser,jdbcType=VARCHAR}
	    </if>
	    <if test="createDate != null">
	       and a.create_date = #{createDate,jdbcType=TIMESTAMP}
	    </if>
	    <if test="createUser != null">
	       and a.create_user = #{createUser,jdbcType=VARCHAR}
	    </if>
	    <if test="providerName != null and providerName != ''">
			and b.name like concat('%',#{providerName,jdbcType=VARCHAR},'%') 
		</if>
    order by a.create_date desc
  </select>
  
  <select id="getAllAgentBillDiscountSql" resultType="java.lang.String">
	SELECT get_sql_for_provid_discount_func(#{physicalId},#{providerId})
  </select>

  <select id="getAllAgentBillDiscountForSql" parameterType="String" resultType="java.util.Map">
	${value}
  </select>
  
  <select id="getColModel" parameterType="java.util.Map" resultType="java.lang.String">
	SELECT DISTINCT
		t1.`value`
	FROM
		mp_provider_bill_discount t LEFT JOIN mp_bill_pkg t1 ON t.bill_pkg_id = t1.id 
	WHERE
		t.del_flag = 1
	AND t.provider_physical_channel_id = #{physicalId}
	AND t.provider_id = #{providerId}
	order by t1.value
  </select>
  
  <update id="updateDiscount" parameterType="java.util.Map">
	update mp_provider_bill_discount 
	<set>
      <if test="discount != null">
        discount = #{discount,jdbcType=DECIMAL},
      </if>
      <if test="realDiscount != null">
        real_discount = #{realDiscount,jdbcType=VARCHAR},
      </if>
    </set>
	where provider_physical_channel_id = #{physicalId,jdbcType=VARCHAR} and provider_id = #{providerId,jdbcType=VARCHAR}
	and province_code = #{provinceCode,jdbcType=VARCHAR} and bill_pkg_id = #{billPkgId,jdbcType=VARCHAR} and del_flag = 1
  </update>
  
  <select id="selectAll" resultType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    	a.*,b.`name` as providerName
    from mp_provider_bill_discount a LEFT JOIN mp_provider b on a.provider_id = b.id 
    where 
    	a.del_flag = 1 
	    <if test="providerPhysicalChannelId != null">
	       and a.provider_physical_channel_id = #{providerPhysicalChannelId,jdbcType=VARCHAR}
	    </if>
	    <if test="physicalId != null">
	       and a.provider_physical_channel_id = #{physicalId,jdbcType=VARCHAR}
	    </if>
	    <if test="providerId != null">
	       and a.provider_id = #{providerId,jdbcType=VARCHAR}
	    </if>
	    <if test="name != null and name != '' ">
	       and a.name like concat('%',#{name,jdbcType=VARCHAR},'%') 
	    </if>
	    <if test="discount != null">
	       and a.discount = #{discount,jdbcType=DECIMAL}
	    </if>
	    <if test="billPkgId != null">
	       and a.bill_pkg_id = #{billPkgId,jdbcType=VARCHAR}
	    </if>
	    <if test="provinceCode != null">
	       and a.province_code = #{provinceCode,jdbcType=VARCHAR}
	    </if>
	    <if test="cityCode != null">
	       and a.city_code = #{cityCode,jdbcType=VARCHAR}
	    </if>
	    <if test="updateDate != null">
	       and a.update_date = #{updateDate,jdbcType=TIMESTAMP}
	    </if>
	    <if test="updateUser != null">
	       and a.update_user = #{updateUser,jdbcType=VARCHAR}
	    </if>
	    <if test="createDate != null">
	       and a.create_date = #{createDate,jdbcType=TIMESTAMP}
	    </if>
	    <if test="createUser != null">
	       and a.create_user = #{createUser,jdbcType=VARCHAR}
	    </if>
	    <if test="providerName != null and providerName != '' ">
			and b.name like concat('%',#{providerName,jdbcType=VARCHAR},'%') 
		</if>
    order by a.create_date desc
  </select>
  <select id="selectDiscountMap" resultType="java.util.Map">
		select
		*
		from mp_provider_bill_discount where del_flag = 1
		<if test="providerId != null">
			and provider_id = #{providerId,jdbcType=VARCHAR}
		</if>
		<if test="providerPhysicalChannelId != null">
			and provider_physical_channel_id =
			#{providerPhysicalChannelId,jdbcType=VARCHAR}
		</if>
		<if test="name != null">
			and name like concat('%',#{name,jdbcType=VARCHAR},'%') 
		</if>
		<if test="discount != null">
			and discount = #{discount,jdbcType=DECIMAL}
		</if>
		<if test="billPkgId != null">
			and bill_pkg_id = #{billPkgId,jdbcType=VARCHAR}
		</if>
		<if test="provinceCode != null">
			and province_code in ('全国',#{provinceCode,jdbcType=VARCHAR})
		</if>
		<if test="cityCode != null">
			and city_code = #{cityCode,jdbcType=VARCHAR}
		</if>
		<if test="updateDate != null">
			and update_date = #{updateDate,jdbcType=TIMESTAMP}
		</if>
		<if test="updateUser != null">
			and update_user = #{updateUser,jdbcType=VARCHAR}
		</if>
		<if test="createDate != null">
			and create_date = #{createDate,jdbcType=TIMESTAMP}
		</if>
		<if test="createUser != null">
			and create_user = #{createUser,jdbcType=VARCHAR}
		</if>
		group by discount
	</select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from mp_provider_bill_discount
    where id = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into mp_provider_bill_discount (id, provider_physical_channel_id, provider_id, 
      name, discount, bill_pkg_id, 
      province_code, city_code, update_date, 
      update_user, create_date, create_user
      )
    values (#{id,jdbcType=VARCHAR}, #{providerPhysicalChannelId,jdbcType=VARCHAR}, #{providerId,jdbcType=VARCHAR}, 
      #{name,jdbcType=VARCHAR}, #{discount,jdbcType=DECIMAL}, #{billPkgId,jdbcType=VARCHAR}, 
      #{provinceCode,jdbcType=VARCHAR}, #{cityCode,jdbcType=VARCHAR}, #{updateDate,jdbcType=TIMESTAMP}, 
      #{updateUser,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, #{createUser,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="java.util.Map">
  <selectKey keyProperty="myuuid" resultType="String" order="BEFORE">select  replace(uuid(),'-','') as myuuid  from dual</selectKey>
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into mp_provider_bill_discount
    <trim prefix="(" suffix=")" suffixOverrides=",">
        id,
      <if test="physicalId != null">
        provider_physical_channel_id,
      </if>
      <if test="providerId != null">
        provider_id,
      </if>
      <if test="name != null">
        name,
      </if>
      <if test="discount != null">
        discount,
      </if>
      <if test="realDiscount != null">
        real_discount,
      </if>
      <if test="billPkgId != null">
        bill_pkg_id,
      </if>
      <if test="provinceCode != null">
        province_code,
      </if>
      <if test="cityCode != null">
        city_code,
      </if>
      <if test="updateDate != null">
        update_date,
      </if>
      <if test="updateUser != null">
        update_user,
      </if>
      <if test="createDate != null">
        create_date,
      </if>
      <if test="createUser != null">
        create_user,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
        #{myuuid,jdbcType=VARCHAR},
      <if test="physicalId != null">
        #{physicalId,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null">
        #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="name != null">
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="discount != null">
        #{discount,jdbcType=DECIMAL},
      </if>
      <if test="realDiscount != null">
        #{realDiscount,jdbcType=DECIMAL},
      </if>
      <if test="billPkgId != null">
        #{billPkgId,jdbcType=VARCHAR},
      </if>
      <if test="provinceCode != null">
        #{provinceCode,jdbcType=VARCHAR},
      </if>
      <if test="cityCode != null">
        #{cityCode,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null">
        #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUser != null">
        #{updateUser,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null">
        #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createUser != null">
        #{createUser,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update mp_provider_bill_discount
    <set>
      <if test="providerPhysicalChannelId != null">
        provider_physical_channel_id = #{providerPhysicalChannelId,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null">
        provider_id = #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="name != null">
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="discount != null">
        discount = #{discount,jdbcType=DECIMAL},
      </if>
      <if test="billPkgId != null">
        bill_pkg_id = #{billPkgId,jdbcType=VARCHAR},
      </if>
      <if test="provinceCode != null">
        province_code = #{provinceCode,jdbcType=VARCHAR},
      </if>
      <if test="cityCode != null">
        city_code = #{cityCode,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null">
        update_date = #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUser != null">
        update_user = #{updateUser,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null">
        create_date = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createUser != null">
        create_user = #{createUser,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
  
  <select id="selectDiscount" resultType="java.lang.Double">
    select 
    	discount
    from mp_provider_bill_discount where del_flag = 1 
    <if test="providerPhysicalChannelId != null">
        provider_physical_channel_id = #{providerPhysicalChannelId,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null">
        provider_id = #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="name != null">
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="discount != null">
        discount = #{discount,jdbcType=DECIMAL},
      </if>
      <if test="billPkgId != null">
        bill_pkg_id = #{billPkgId,jdbcType=VARCHAR},
      </if>
      <if test="provinceCode != null">
        province_code = #{provinceCode,jdbcType=VARCHAR},
      </if>
      <if test="cityCode != null">
        city_code = #{cityCode,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null">
        update_date = #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUser != null">
        update_user = #{updateUser,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null">
        create_date = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createUser != null">
        create_user = #{createUser,jdbcType=VARCHAR},
      </if>
  </select>
  
  	<select id="getProviderBillDiscountByBillPkgId" resultType="java.util.Map">
	select * from mp_provider_bill_discount where del_flag=1 and bill_pkg_id=#{bill_pkg_id,jdbcType=VARCHAR}
	</select>
	<select id="getProviderBillDiscountByBillPkgIdAndProvinceCode" resultType="java.util.Map">
	select * from mp_provider_bill_discount where del_flag=1 and bill_pkg_id=#{bill_pkg_id,jdbcType=VARCHAR} and province_code=#{province_code,jdbcType=VARCHAR}
	</select>
	
  	<insert id="providerBillDiscountAdd" >
	<selectKey keyProperty="myuuid" resultType="String" order="BEFORE">select  replace(uuid(),'-','') as myuuid  from dual</selectKey>
		insert into mp_provider_bill_discount (id, provider_physical_channel_id, provider_id, 
		   name, discount, bill_pkg_id, 
		   province_code, city_code, update_date, 
		   update_user, create_date, create_user
		   )
		 values (#{myuuid,jdbcType=VARCHAR}, #{providerPhysicalChannelId,jdbcType=VARCHAR}, #{providerId,jdbcType=VARCHAR}, 
		   #{name,jdbcType=VARCHAR}, #{discount,jdbcType=DECIMAL}, #{billPkgId,jdbcType=VARCHAR}, 
		   #{provinceCode,jdbcType=VARCHAR}, #{cityCode,jdbcType=VARCHAR}, #{updateDate,jdbcType=TIMESTAMP}, 
		   #{updateUser,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, #{createUser,jdbcType=VARCHAR}
		   )
	</insert>
	
	<update id="providerBillDiscountEdit">
	  update mp_provider_bill_discount
	  <set> 
      discount=#{discount,jdbcType=VARCHAR},update_date=CURRENT_TIMESTAMP,update_user=#{update_user,jdbcType=VARCHAR}
      </set>
	  where id=#{id,jdbcType=VARCHAR}
	</update>
	
    <delete id="deleteProviderBillDiscountByBillPkgId">
	 UPDATE mp_provider_bill_discount SET del_flag = 0 where bill_pkg_id=#{bill_pkg_id,jdbcType=VARCHAR}
	</delete>
	
	<delete
		id="deleteProviderBillDiscount">
		UPDATE mp_provider_bill_discount SET del_flag = 0
		where 
		  	provider_physical_channel_id=#{providerPhysicalChannelId,jdbcType=VARCHAR}
			and provider_id = #{providerId,jdbcType=VARCHAR}
			and province_code = #{provinceCode,jdbcType=VARCHAR}
	</delete>
	
	<delete id="deleteDiscountDel">
		UPDATE mp_provider_bill_discount SET del_flag = 0 where provider_physical_channel_id=#{physicalId} and provider_id=#{providerId}
	</delete>
	
	<select id="getAllProviderBillDiscount" resultType="java.util.Map">
		SELECT
			t.provider_physical_channel_id physicalId,
			t.provider_id providerId,
			t.province_code provinceCode,
			sum(if(t1.`value`=10,t.discount,0)) fee10,
			sum(if(t1.`value`=10,t.real_discount,0)) fee10Rel,
			sum(if(t1.`value`=20,t.discount,0)) fee20,
			sum(if(t1.`value`=20,t.real_discount,0)) fee20Rel,
			sum(if(t1.`value`=30,t.discount,0)) fee30,
			sum(if(t1.`value`=30,t.real_discount,0)) fee30Rel,
			sum(if(t1.`value`=50,t.discount,0)) fee50,
			sum(if(t1.`value`=50,t.real_discount,0)) fee50Rel,
			sum(if(t1.`value`=100,t.discount,0)) fee100,
			sum(if(t1.`value`=100,t.real_discount,0)) fee100Rel,
			sum(if(t1.`value`=200,t.discount,0)) fee200,
			sum(if(t1.`value`=200,t.real_discount,0)) fee200Rel,
			sum(if(t1.`value`=300,t.discount,0)) fee300,
			sum(if(t1.`value`=300,t.real_discount,0)) fee300Rel,
			sum(if(t1.`value`=500,t.discount,0)) fee500,
			sum(if(t1.`value`=500,t.real_discount,0)) fee500Rel
		FROM
			mp_provider_bill_discount t
		LEFT JOIN mp_bill_pkg t1 ON t1.id = t.bill_pkg_id
		WHERE
			t.del_flag = 1
			and t.provider_physical_channel_id=#{physicalId}
			and t.provider_id=#{providerId}
		GROUP BY
			t.provider_physical_channel_id,
			t.provider_id,
			t.province_code
	</select>
	
	<select id="getProviderBillDiscountListCount" resultType="java.lang.Integer">
		select count(0) from (
			SELECT
				t.provider_physical_channel_id physicalId,
				t.provider_id providerId,
				t.province_code provinceCode,
				sum(if(t1.`value`=10,t.discount,0)) fee10,
				sum(if(t1.`value`=10,t.real_discount,0)) fee10Rel,
				sum(if(t1.`value`=20,t.discount,0)) fee20,
				sum(if(t1.`value`=20,t.real_discount,0)) fee20Rel,
				sum(if(t1.`value`=30,t.discount,0)) fee30,
				sum(if(t1.`value`=30,t.real_discount,0)) fee30Rel,
				sum(if(t1.`value`=50,t.discount,0)) fee50,
				sum(if(t1.`value`=50,t.real_discount,0)) fee50Rel,
				sum(if(t1.`value`=100,t.discount,0)) fee100,
				sum(if(t1.`value`=100,t.real_discount,0)) fee100Rel,
				sum(if(t1.`value`=200,t.discount,0)) fee200,
				sum(if(t1.`value`=200,t.real_discount,0)) fee200Rel,
				sum(if(t1.`value`=300,t.discount,0)) fee300,
				sum(if(t1.`value`=300,t.real_discount,0)) fee300Rel,
				sum(if(t1.`value`=500,t.discount,0)) fee500,
				sum(if(t1.`value`=500,t.real_discount,0)) fee500Rel
			FROM
				mp_provider_bill_discount t
			LEFT JOIN mp_bill_pkg t1 ON t1.id = t.bill_pkg_id
			WHERE
				t.del_flag = 1
				and t.provider_physical_channel_id=#{physicalId}
				and t.provider_id=#{providerId}
			GROUP BY
				t.provider_physical_channel_id,
				t.provider_id,
				t.province_code
		)a
	</select>
</mapper>