<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hyfd.dao.mp.ProviderGroupBillRelDao">
	<select id="selectPhysicalChannel" resultType="java.util.Map">
		SELECT
		  id,provider_physical_channel_id,provider_id,discount,province_code
		FROM
			mp_provider_bill_discount
		WHERE del_flag=1 and
			bill_pkg_id = #{pkgId,jdbcType=VARCHAR}
			and (provider_id ,provider_physical_channel_id,province_code) in(
				select provider_id,provider_physical_channel_id,province_code from
				mp_provider_group_bill_rel 
				where del_flag=1 and provider_id = #{providerId,jdbcType=VARCHAR}
				and group_id=#{groupId}
				and province_code in('全国',#{provinceCode,jdbcType=VARCHAR})
			)order by discount
  </select>
  
  <update id='updateGroupBillByDispatcher' parameterType="java.util.Map">
  	update mp_provider_group_bill_rel set del_flag=#{flag} where provider_id=#{providerId}
  	and provider_physical_channel_id=#{physicalId}
  </update>
  
  <update id="updateGroupBillDelFlag">
  	update mp_provider_group_bill_rel set del_flag=#{flag} where provider_id=#{providerId}
  	and provider_physical_channel_id=#{physicalId} and province_code=#{provinceCode} 
  	and group_id=#{groupId}
  </update>
  
  <select id="selectGroupBillRel" resultType="java.util.Map" parameterType="java.util.Map">
  	select * from mp_provider_group_bill_rel where provider_id=#{providerId}
  	and provider_physical_channel_id=#{physicalId} and province_code=#{provinceCode}
  	and group_id=#{groupId}
  </select>
  
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    a.id, a.group_id, a.provider_id,a.province_code,a.city_code,a.provider_physical_channel_id as physicalId,
    date_format(a.update_date, '%Y-%m-%d %H:%i:%s') as update_date,
    a.update_user, 
    date_format(a.create_date, '%Y-%m-%d %H:%i:%s') as create_date,
    a.create_user,
    b.name as providerName,
    c.name as physicalName,
    d.suName as userName
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from mp_provider_group_bill_rel a
    where a.id = #{id,jdbcType=VARCHAR}
  </select>
  
  <select id="querySelectGroupByGroupId" resultType="java.util.Map">
  	select 
    	a.id, 
    	a.group_id groupId, 
    	a.provider_id providerId,
    	a.province_code provinceCode,
    	a.city_code,
    	a.provider_physical_channel_id as physicalId
    from mp_provider_group_bill_rel a 
    where a.del_flag=1 and a.group_id = #{groupId,jdbcType=VARCHAR}
  </select>
  
  
  
  <select id="selectAll" resultType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from mp_provider_group_bill_rel a 
    LEFT JOIN mp_provider b on a.provider_id=b.id 
    left join mp_provider_physical_channel c on a.provider_physical_channel_id=c.id
    left join sysusert d on d.suId=a.create_user
    where a.del_flag=1 and b.del_flag=1 and c.del_flag=1 and d.del_flag=1
    <if test="providerName != null and providerName !=''">
       and b.name like concat('%',#{providerName,jdbcType=VARCHAR},'%')
    </if>
    <if test="provinceCode != null and provinceCode !=''">
       and a.province_code like  concat('%',#{provinceCode,jdbcType=VARCHAR},'%')
    </if>
    and a.group_id=#{groupId}
	order by a.create_date desc
  </select>
  <select id="selectCount" resultType="Integer">
  select count(1)  from mp_provider_group_bill_rel a 
    LEFT JOIN mp_provider b on a.provider_id=b.id 
    where a.del_flag=1 and b.del_flag=1
    <if test="providerName != null and providerName !=''">
       and b.name like concat('%',#{providerName,jdbcType=VARCHAR},'%')
    </if>
    <if test="provinceCode != null and provinceCode !=''">
       and a.province_code like  concat('%',#{provinceCode,jdbcType=VARCHAR},'%')
    </if>
    and group_id=#{groupId}
	order by a.create_date desc
  </select>
  
  <update id="deleteByPrimaryKey" >
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update mp_provider_group_bill_rel set del_flag=0
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <delete id="deleteByGroupId">
  	delete from mp_provider_group_bill_rel WHERE group_id=#{groupId,jdbcType=VARCHAR} 
  </delete>
  <update id="deleteBygroupIdAndProviderId">
  update mp_provider_group_bill_rel set del_flag=0
    WHERE group_id=#{groupId,jdbcType=VARCHAR} and provider_id=#{providerId,jdbcType=VARCHAR} 
  </update>
  
  <insert id="insert" >
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into mp_provider_group_bill_rel (id, group_id, provider_id, 
      update_date, update_user, create_date, 
      create_user)
    values (#{id,jdbcType=VARCHAR}, #{groupId,jdbcType=VARCHAR}, #{providerId,jdbcType=VARCHAR}, 
      #{updateDate,jdbcType=TIMESTAMP}, #{updateUser,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, 
      #{createUser,jdbcType=VARCHAR})
  </insert>
  <insert id="insertBillGroupRel">
  	<selectKey keyProperty="myuuid" resultType="String" order="BEFORE">select  replace(uuid(),'-','') as myuuid  from dual</selectKey>
    insert into mp_provider_group_bill_rel
    <trim prefix="(" suffix=")" suffixOverrides=",">
        id,
      <if test="groupId != null and groupId != '' ">
        group_id,
      </if>
      <if test="providerId != null and providerId != ''">
        provider_id,
      </if>
      <if test="provinceCode != null and provinceCode != ''">
       province_code,
      </if>
      <if test="cityCode != null and cityCode != ''">
        city_code,
      </if>
      <if test="physicalId != null and physicalId != ''">
       provider_physical_channel_id,
      </if>
      <if test="updateDate != null and updateDate != ''">
        update_date,
      </if>
      <if test="updateUser != null and updateUser != ''">
        update_user,
      </if>
        create_date,
      <if test="createUser != null and createUser != ''">
        create_user,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{myuuid,jdbcType=VARCHAR},
      <if test="groupId != null and groupId != ''">
        #{groupId,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null and providerId != ''">
        #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="provinceCode != null and provinceCode != ''">
        #{provinceCode,jdbcType=VARCHAR},
      </if>
      <if test="cityCode != null and cityCode != ''">
        #{cityCode,jdbcType=VARCHAR},
      </if>
      <if test="physicalId != null and physicalId != ''">
       #{physicalId},
      </if>
      <if test="updateDate != null and updateDate != ''">
        CURRENT_TIMESTAMP,
      </if>
      <if test="updateUser != null and updateUser != ''">
        #{updateUser,jdbcType=VARCHAR},
      </if>
     	CURRENT_TIMESTAMP,
      <if test="createUser != null and createUser != ''">
        #{createUser,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <insert id="insertSelective" >
  <selectKey keyProperty="myuuid" resultType="String" order="BEFORE">select  replace(uuid(),'-','') as myuuid  from dual</selectKey>
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into mp_provider_group_bill_rel
    <trim prefix="(" suffix=")" suffixOverrides=",">
        id,
      <if test="groupId != null and groupId != '' ">
        group_id,
      </if>
      <if test="providerId != null and providerId != ''">
        provider_id,
      </if>
      <if test="provinceCode != null and provinceCode != ''">
       province_code,
      </if>
      <if test="cityCode != null and cityCode != ''">
        city_code,
      </if>
      <if test="updateDate != null and updateDate != ''">
        update_date,
      </if>
      <if test="updateUser != null and updateUser != ''">
        update_user,
      </if>
        create_date,
      <if test="createUser != null and createUser != ''">
        create_user,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{myuuid,jdbcType=VARCHAR},
      <if test="groupId != null and groupId != ''">
        #{groupId,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null and providerId != ''">
        #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="provinceCode != null and provinceCode != ''">
        #{provinceCode,jdbcType=VARCHAR},
      </if>
      <if test="cityCode != null and cityCode != ''">
        #{cityCode,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null and updateDate != ''">
        #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUser != null and updateUser != ''">
        #{updateUser,jdbcType=VARCHAR},
      </if>
     	CURRENT_TIMESTAMP,
      <if test="createUser != null and createUser != ''">
        #{createUser,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update mp_provider_group_bill_rel
    <set>
      <if test="groupId != null">
        group_id = #{groupId,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null">
        provider_id =  #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="provinceCode != null">
        province_code =  #{provinceCode,jdbcType=VARCHAR},
      </if>
      <if test="cityCode != null">
       city_code = #{cityCode,jdbcType=VARCHAR},
      </if>
      update_date=CURRENT_TIMESTAMP,
      <if test="updateUser != null">
        #{updateUser,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <select id="countByBillGroupIdAndProviderId" resultType="java.lang.Integer">
    select count(1)
    from mp_provider_group_bill_rel 
    where del_flag=1 and group_id = #{billGroupId,jdbcType=VARCHAR} and provider_id = #{providerId,jdbcType=VARCHAR} and (province_code = #{provinceCode,jdbcType=VARCHAR} or province_code = '全国')
  </select>
	<select id="getGroupRelProvince" resultType="java.lang.String">
	  select a.province_code from mp_provider_group_bill_rel a where a.del_flag=1 and a.group_id=#{groupId}
	   and a.provider_id = #{providerId,jdbcType=VARCHAR} 
	   <if test="provinceCode != null and provinceCode !=''">
       and a.province_code not in (#{provinceCode,jdbcType=VARCHAR})
    	</if>
	   group by a.province_code
	</select>
	
	<insert id="ProviderGroupBillRelAdd" >
	<selectKey keyProperty="myuuid" resultType="String" order="BEFORE">select  replace(uuid(),'-','') as myuuid  from dual</selectKey>
	 insert into mp_provider_group_bill_rel(id,group_id,provider_id,create_date,create_user) 
	  VALUES(#{myuuid,jdbcType=VARCHAR},#{group_id,jdbcType=VARCHAR},#{provider_id,jdbcType=VARCHAR},CURRENT_TIMESTAMP,#{create_user,jdbcType=VARCHAR})
	</insert>
	
	<update id="ProviderGroupBillRelEdit">
	update mp_provider_group_bill_rel set group_id=#{group_id,jdbcType=VARCHAR},provider_id=#{provider_id,jdbcType=VARCHAR},
	update_date=CURRENT_TIMESTAMP,update_user=#{update_user,jdbcType=VARCHAR} where id=#{id,jdbcType=VARCHAR}
	</update>
	
	<sql id="myWhere">
    <where>
    <if test="groupId != null and groupId !=''">
       and a.group_id = #{groupId,jdbcType=VARCHAR}
    </if>
    <if test="providerId != null and providerId !=''">
       and a.provider_id = #{providerId,jdbcType=VARCHAR}
    </if>
    <if test="provinceCode != null and provinceCode !=''">
       and a.province_code = #{provinceCode,jdbcType=VARCHAR}
    </if>
    <if test="cityCode != null and cityCode !=''">
       and a.city_code = #{cityCode,jdbcType=VARCHAR}
    </if>
    <if test="updateDate != null and updateDate !=''">
       and a.update_date = #{updateDate,jdbcType=TIMESTAMP}
    </if>
    <if test="updateUser != null and updateUser !=''">
       and a.update_user = #{updateUser,jdbcType=VARCHAR}
    </if>
    <if test="createDate != null and createDate !=''">
       and a.create_date = #{createDate,jdbcType=TIMESTAMP}
    </if>
    <if test="createUser != null and createUser !=''">
       and a.create_user = #{createUser,jdbcType=VARCHAR}
    </if>
    </where>
  </sql>
  
  <select id='getProviderIdByGroupId' resultType="java.util.Map">
  	select t.provider_id providerId,t1.name
  	from mp_provider_group_bill_rel t
  	left join mp_provider t1 on t1.id=t.provider_id 
  	where t.del_flag=1 and t1.del_flag=1 and t.group_id=#{groupId} 
  	group by t.provider_id
  </select>
  
   <select id='getPhysicalIdByProviderId' resultType="java.util.Map">
  	select t.provider_physical_channel_id physicalId,t1.name
  	from mp_provider_group_bill_rel t
  	left join mp_provider_physical_channel t1 on t1.id=t.provider_physical_channel_id 
  	where t.del_flag=1 and t1.del_flag=1 and t.group_id=#{groupId}
  	and t.provider_id = #{providerId} 
  	group by t.provider_physical_channel_id
  </select>
  <select id='getProvinceCodeByPhysicalId' resultType="java.util.Map">
  	select t.province_code provinceCode
  	from mp_provider_group_bill_rel t 
  	where t.del_flag=1 and t.group_id=#{groupId}
  	and t.provider_id = #{providerId}
  	and t.provider_physical_channel_id = #{physicalId} 
  	group by t.province_code
  </select>
  <select id="selectPhysicalChannelExt" resultType="java.util.Map">
	select a.*,CASE when b.agent_id is not null then '1' else '0' end as
		isRelChannel from
		(
			SELECT
				id,provider_physical_channel_id,provider_id,discount,real_discount,province_code
			FROM
				mp_provider_bill_discount
			WHERE
				bill_pkg_id = #{pkgId,jdbcType=VARCHAR}
				and (provider_id ,provider_physical_channel_id,province_code) in(
					select 
						p1.provider_id,p1.provider_physical_channel_id,p1.province_code 
					from
						mp_provider_group_bill_rel p1,mp_provider_physical_channel p2
					where 
						p1.provider_id = #{providerId,jdbcType=VARCHAR}
						and p1.group_id=#{groupId}
						and p1.province_code in('全国',#{provinceCode,jdbcType=VARCHAR})
						and p1.del_flag =1
						and p1.provider_physical_channel_id = p2.id
					    and p2.channel_type = #{channelType,jdbcType=VARCHAR}

				)
				and del_flag = 1
		) a
		LEFT JOIN
		(
			select * from mp_agent_channel_rel
			where
				flag = 1
				and del_flag = 1
				and provider_id = #{providerId,jdbcType=VARCHAR}
				and agent_id = #{agentId,jdbcType=VARCHAR}
				and province_code in ('全国',#{provinceCode,jdbcType=VARCHAR})
		) b
		on (
			a.provider_id = b.provider_id
			and a.provider_physical_channel_id = b.provider_physical_channel_id
			and a.province_code = b.province_code
		)
		order by b.agent_id desc,a.real_discount,a.provider_physical_channel_id asc

	</select>
</mapper>