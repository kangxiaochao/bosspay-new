<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hyfd.dao.mp.ProviderBillDispatcherDao">
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, provider_id, provider_physical_channel_id, province_code ,city_code,weight, update_date, update_user, create_date, 
    create_user
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from mp_provider_bill_dispatcher
    where id = #{id,jdbcType=VARCHAR}
  </select>
  <select id="selectAll" resultType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from mp_provider_bill_dispatcher where del_flag = 1 
    <if test="providerId != null">
       and provider_id = #{providerId,jdbcType=VARCHAR}
    </if>
    <if test="providerPhysicalChannelId != null">
       and provider_physical_channel_id = #{providerPhysicalChannelId,jdbcType=VARCHAR}
    </if>
    <if test="weight != null">
       and weight = #{weight,jdbcType=VARCHAR}
    </if>
    <if test="updateDate != null">
       and update_date = #{updateDate,jdbcType=TIMESTAMP}
    </if>
    <if test="updateUser != null">
       and update_user = #{updateUser,jdbcType=VARCHAR}
    </if>
    <if test="createDate != null">
       and create_date = #{createDate,jdbcType=TIMESTAMP}
    </if>
    <if test="createUser != null">
       and create_user = #{createUser,jdbcType=VARCHAR}
    </if>
  </select>
  
  <select id="selectProvinceCode" resultType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from mp_provider_bill_dispatcher where del_flag = 1 
    <if test="providerId != null">
       and provider_id = #{providerId,jdbcType=VARCHAR}
    </if>
    <if test="providerPhysicalChannelId != null">
       and provider_physical_channel_id = #{providerPhysicalChannelId,jdbcType=VARCHAR}
    </if>
    <if test="weight != null">
       and weight = #{weight,jdbcType=VARCHAR}
    </if>
    <if test="updateDate != null">
       and update_date = #{updateDate,jdbcType=TIMESTAMP}
    </if>
    <if test="updateUser != null">
       and update_user = #{updateUser,jdbcType=VARCHAR}
    </if>
    <if test="createDate != null">
       and create_date = #{createDate,jdbcType=TIMESTAMP}
    </if>
    <if test="createUser != null">
       and create_user = #{createUser,jdbcType=VARCHAR}
    </if>
  </select>
  
  <select id="selectCount" resultType="Integer">
  select count(1)  from mp_provider_bill_dispatcher a 
    LEFT JOIN mp_provider b on a.provider_id=b.id
    where 1=1
    <if test="providerName != null">
       and b.name like concat('%',#{providerName,jdbcType=VARCHAR},'%')
    </if>
    <if test="provinceCode != null">
       and a.province_code like concat('%',#{provinceCode,jdbcType=VARCHAR},'%')
    </if>
    and a.provider_physical_channel_id=#{physicalId}
	order by a.create_date desc
  </select>
  <update id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update mp_provider_bill_dispatcher set del_flag=0
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <insert id="insert" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into mp_provider_bill_dispatcher (id, provider_id, provider_physical_channel_id, 
      weight, update_date, update_user, 
      create_date, create_user)
    values (#{id,jdbcType=VARCHAR}, #{providerId,jdbcType=VARCHAR}, #{providerPhysicalChannelId,jdbcType=VARCHAR}, 
      #{weight,jdbcType=VARCHAR}, #{updateDate,jdbcType=TIMESTAMP}, #{updateUser,jdbcType=VARCHAR}, 
      #{createDate,jdbcType=TIMESTAMP}, #{createUser,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into mp_provider_bill_dispatcher
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="providerId != null">
        provider_id,
      </if>
      <if test="providerPhysicalChannelId != null">
        provider_physical_channel_id,
      </if>
      <if test="weight != null">
        weight,
      </if>
      <if test="updateDate != null">
        update_date,
      </if>
      <if test="updateUser != null">
        update_user,
      </if>
      <if test="createDate != null">
        create_date,
      </if>
      <if test="createUser != null">
        create_user,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null">
        #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="providerPhysicalChannelId != null">
        #{providerPhysicalChannelId,jdbcType=VARCHAR},
      </if>
      <if test="weight != null">
        #{weight,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null">
        #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUser != null">
        #{updateUser,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null">
        #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createUser != null">
        #{createUser,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update mp_provider_bill_dispatcher
    <set>
      <if test="providerId != null">
        provider_id = #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="providerPhysicalChannelId != null">
        provider_physical_channel_id = #{dispatcherProviderId,jdbcType=VARCHAR},
      </if>
      <if test="weight != null">
        weight = #{weight,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null">
        update_date = #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUser != null">
        update_user = #{updateUser,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null">
        create_date = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createUser != null">
        create_user = #{createUser,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
<!--   <select id="selectDispatcherByProviderId" parameterType="java.lang.String" resultType="java.util.Map">
    SELECT
	DISTINCT a.*
	FROM
		mp_provider_bill_dispatcher a
	INNER JOIN mp_provider_bill_discount b ON a.provider_physical_channel_id = b.provider_physical_channel_id
	WHERE
		a.provider_id = #{providerId,jdbcType=VARCHAR}
	AND a.province_code = #{provinceCode,jdbcType=VARCHAR}
	and b.province_code = #{provinceCode,jdbcType=VARCHAR}
	and b.bill_pkg_id = #{pkgId,jdbcType=VARCHAR}
	order by b.discount
  </select> -->
  
  <select id="selectDispatcherByProviderId" parameterType="java.lang.String" resultType="java.util.Map">
    SELECT
	  id,provider_physical_channel_id,provider_id,discount,province_code
	FROM
		mp_provider_bill_discount
	WHERE
		del_flag=1 and
		bill_pkg_id = #{pkgId,jdbcType=VARCHAR}
		and (provider_id ,provider_physical_channel_id,province_code) in(
			select provider_id,provider_physical_channel_id,province_code from
			mp_provider_bill_dispatcher 
			where del_flag=1 and provider_id = #{providerId,jdbcType=VARCHAR}
			and province_code in('全国',#{provinceCode,jdbcType=VARCHAR})
		)order by discount
  </select>  
  
	<select id="selectDispatcher" parameterType="java.util.Map" resultType="java.util.Map">
	    SELECT
		 *
		FROM
		 mp_provider_bill_dispatcher
		WHERE provider_id = #{providerId,jdbcType=VARCHAR}
		and province_code = #{provinceCode,jdbcType=VARCHAR}
		and provider_physical_channel_id = #{physicalId,jdbcType=VARCHAR}
  	</select>
  
    <select id="getProviderBillDispatcherByProverId" parameterType="java.lang.String" resultType="java.util.Map">
    SELECT * FROM mp_provider_bill_dispatcher WHERE del_flag=1 and provider_id = #{provider_id,jdbcType=VARCHAR}
    </select>
    
    <select id="getDispatcherByPhysicalId" parameterType="java.util.Map" resultType="java.util.Map">
    select a.id,b.id providerId,b.name,group_concat(a.province_code Separator ',') as provinceCode,a.del_flag delFlag  from mp_provider_bill_dispatcher a 
    LEFT JOIN mp_provider b on a.provider_id=b.id
    where 1=1
    <if test="providerName != null">
       and b.name like concat('%',#{providerName,jdbcType=VARCHAR},'%')
    </if>
    <if test="provinceCode != null">
       and a.province_code like concat('%',#{provinceCode,jdbcType=VARCHAR},'%')
    </if>
    and a.provider_physical_channel_id = #{physicalId,jdbcType=VARCHAR}
     GROUP BY provider_id
	<!-- order by a.create_date desc -->
    </select>
    
    <select id="querySelectDispatcherByPhysicalId" resultType="java.util.Map">
    	select id,provider_id providerId,provider_physical_channel_id physicalId,province_code provinceCode from mp_provider_bill_dispatcher
    	where del_flag=1 and provider_physical_channel_id=#{physicalId}
    </select>
    
	<insert id="providerBillDispatcherAdd" >
	<selectKey keyProperty="myuuid" resultType="String" order="BEFORE">select  replace(uuid(),'-','') as myuuid  from dual</selectKey>
    insert into mp_provider_bill_dispatcher(id,provider_id,provider_physical_channel_id,province_code,
    weight,create_date,create_user) values(
    #{myuuid,jdbcType=VARCHAR},#{provider_id,jdbcType=VARCHAR},#{provider_physical_channel_id,jdbcType=VARCHAR},#{province_code,jdbcType=VARCHAR},
    #{weight,jdbcType=VARCHAR},CURRENT_TIMESTAMP,#{create_user,jdbcType=VARCHAR});
	</insert>
	
  <update id="providerBillDispatcherDelByProviderId">
    update mp_provider_bill_dispatcher set del_flag=0 where provider_id=#{provider_id,jdbcType=VARCHAR}
  </update>
  	<delete id="deleteByPhysicalId">
  		delete from  mp_provider_bill_dispatcher where provider_physical_channel_id=#{physicalId,jdbcType=VARCHAR}
  	</delete>
  	
  	<update id="updateDelFlag" parameterType="java.util.Map">
  		update mp_provider_bill_dispatcher set del_flag=#{flag} where provider_id=#{providerId} and provider_physical_channel_id=#{physicalId,jdbcType=VARCHAR}
  	</update>
  	
  	<update id="updateDelFlagByDispatcher" parameterType="java.util.Map">
  		update mp_provider_bill_dispatcher set del_flag=#{flag} where province_code=#{provinceCode} and provider_id=#{providerId} 
  		and provider_physical_channel_id =#{physicalId}
  	</update>
  	
  <select id="getProviderAll" resultType="java.util.Map" parameterType="java.lang.String">
  	SELECT
		t.provider_id providerId,
		t1. NAME name
	FROM
		mp_provider_bill_dispatcher t
	LEFT JOIN mp_provider t1 ON t1.id = t.provider_id
	WHERE
		t.del_flag=1 and t1.del_flag=1
		and t.provider_id IN (
			SELECT
				provider_id
			FROM
				mp_provider_group_bill_rel
			WHERE
				del_flag=1
				and group_id = #{groupId}
		)
	GROUP BY
		t.provider_id
  	
  </select>
  
  <select id="getPhysicalAll" resultType="java.util.Map" parameterType="java.util.Map">
	SELECT
		t.provider_physical_channel_id physicalId,
		t1. NAME name
	FROM
		mp_provider_bill_dispatcher t
	LEFT JOIN mp_provider_physical_channel t1 ON t1.id = t.provider_physical_channel_id
	WHERE
		t.del_flag=1 and t1.del_flag=1
		and t.provider_id = #{providerId}
	GROUP BY
		t.provider_physical_channel_id
  </select>
  
  <select id="getProvinceAll" resultType="java.util.Map" parameterType="java.util.Map">
	SELECT
		t.province_code provinceCode
	FROM
		mp_provider_bill_dispatcher t
	INNER JOIN 
		mp_provider p ON t.provider_id=p.id
	WHERE
	t.del_flag=1 and
	t.provider_id = #{providerId}
	and t.provider_physical_channel_id=#{physicalId}
	and p.provider_type = 1
	GROUP BY
		t.province_code
  </select>

  <!-- 获取可用通道组,获取订单详细参数时使用 -->
  <select id="selectProviderPhysicalChannel" parameterType="java.lang.String" resultType="java.util.Map">
    SELECT
	  a.id,a.provider_physical_channel_id,a.provider_id,a.discount,a.province_code,b.`name`
	FROM
		mp_provider_bill_discount a 
	left join 
		mp_provider_physical_channel b 
	on 
		a.provider_physical_channel_id = b.id
	WHERE
		a.del_fla=1 and b.del_flag=1
		and a.bill_pkg_id = #{pkgId,jdbcType=VARCHAR}
		and (a.provider_id ,a.provider_physical_channel_id,a.province_code) in(
			select provider_id,provider_physical_channel_id,province_code from
			mp_provider_bill_dispatcher 
			where provider_id = #{providerId,jdbcType=VARCHAR}
			and province_code in('全国',#{provinceCode,jdbcType=VARCHAR})
		)order by a.discount,province_code
  </select> 
  
  <insert id="insertDispatcher">
  	<selectKey keyProperty="myuuid" resultType="String" order="BEFORE">select  replace(uuid(),'-','') as myuuid  from dual</selectKey>
    insert into mp_provider_bill_dispatcher
    <trim prefix="(" suffix=")" suffixOverrides=",">
        id,
      <if test="providerId != null and providerId != ''">
        provider_id,
      </if>
      <if test="provinceCode != null and provinceCode != ''">
       province_code,
      </if>
      <if test="cityCode != null and cityCode != ''">
        city_code,
      </if>
      <if test="physicalId != null and physicalId != ''">
       provider_physical_channel_id,
      </if>
      <if test="updateDate != null and updateDate != ''">
        update_date,
      </if>
      <if test="updateUser != null and updateUser != ''">
        update_user,
      </if>
        create_date,
      <if test="createUser != null and createUser != ''">
        create_user,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{myuuid,jdbcType=VARCHAR},
      <if test="providerId != null and providerId != ''">
        #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="provinceCode != null and provinceCode != ''">
        #{provinceCode,jdbcType=VARCHAR},
      </if>
      <if test="cityCode != null and cityCode != ''">
        #{cityCode,jdbcType=VARCHAR},
      </if>
      <if test="physicalId != null and physicalId != ''">
       #{physicalId},
      </if>
      <if test="updateDate != null and updateDate != ''">
        CURRENT_TIMESTAMP,
      </if>
      <if test="updateUser != null and updateUser != ''">
        #{updateUser,jdbcType=VARCHAR},
      </if>
     	CURRENT_TIMESTAMP,
      <if test="createUser != null and createUser != ''">
        #{createUser,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
</mapper>