<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hyfd.dao.mp.AgentBillDiscountDao">
	<sql id="Base_Column_List">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		a.*,date_format(a.update_date, '%Y-%m-%d %H:%i:%s') as update_date,
		date_format(a.create_date, '%Y-%m-%d %H:%i:%s') as create_date,
		b.name as providerName,c.name as billPkgName 
	</sql>
	
	<select id="selectCount" resultType="Integer">
	select 
    	count(1)
    from mp_agent_bill_discount a
		LEFT JOIN 
			mp_provider b ON a.provider_id=b.id LEFT JOIN mp_bill_pkg c on
			a.bill_pkg_id=c.id 
    where 1=1
	    <if test="agentId != null and agentId !='' ">
	       and a.agent_id = #{agentId,jdbcType=VARCHAR}
	    </if>
	     <if test="providerId != null and providerId !=''">
	       and a.provider_id = #{providerId,jdbcType=VARCHAR}
	    </if>
	    and a.del_flag = 1
	</select>
	<select id="getAllAgentBillDiscount" resultType="java.util.Map">
		SELECT
			t.agent_id agentId,
			t.provider_id providerId,
			t.province_code provinceCode,
			sum(if(t1.`value`=10,t.discount,0)) fee10,
			sum(if(t1.`value`=20,t.discount,0)) fee20,
			sum(if(t1.`value`=30,t.discount,0)) fee30,
			sum(if(t1.`value`=50,t.discount,0)) fee50,
			sum(if(t1.`value`=100,t.discount,0)) fee100,
			sum(if(t1.`value`=200,t.discount,0)) fee200,
			sum(if(t1.`value`=300,t.discount,0)) fee300,
			sum(if(t1.`value`=500,t.discount,0)) fee500
		FROM
			mp_agent_bill_discount t
		LEFT JOIN mp_bill_pkg t1 ON t1.id = t.bill_pkg_id
		where t.del_flag=1
		AND t.agent_id = #{agentId}
		AND t.provider_id = #{providerId}
		GROUP BY t.agent_id,
			t.provider_id,
			t.province_code
	</select>
	
	<select id="getAllAgentBillDiscountSql" resultType="java.lang.String">
		SELECT get_sql_for_agent_discount_func(#{agentId},#{providerId})
	</select>
	
	<select id="getAllAgentBillDiscountForSql" parameterType="String" resultType="java.util.Map">
		${value}
	</select>
	
	<select id="getColModel" parameterType="java.util.Map" resultType="java.lang.String">
		SELECT DISTINCT
			t1.`value`
		FROM
			mp_agent_bill_discount t LEFT JOIN mp_bill_pkg t1 ON t.bill_pkg_id = t1.id 
		WHERE
			t.del_flag = 1
		AND t.agent_id = #{agentId}
		AND t.provider_id = #{providerId}
		order by t1.value
	</select>
	
	<select id="getAgentBillDiscountListCount" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT COUNT(0) from (
			SELECT
				t.agent_id agentId,
				t.provider_id providerId,
				t.province_code provinceCode,
				sum(if(t1.`value`=10,t.discount,0)) fee10,
				sum(if(t1.`value`=20,t.discount,0)) fee20,
				sum(if(t1.`value`=30,t.discount,0)) fee30,
				sum(if(t1.`value`=50,t.discount,0)) fee50,
				sum(if(t1.`value`=100,t.discount,0)) fee100,
				sum(if(t1.`value`=200,t.discount,0)) fee200,
				sum(if(t1.`value`=300,t.discount,0)) fee300,
				sum(if(t1.`value`=500,t.discount,0)) fee500
			FROM
				mp_agent_bill_discount t
			LEFT JOIN mp_bill_pkg t1 ON t1.id = t.bill_pkg_id
			where t.del_flag=1
			AND t.agent_id = #{agentId,jdbcType=VARCHAR}
			AND t.provider_id = #{providerId,jdbcType=VARCHAR}
			GROUP BY t.agent_id,
				t.provider_id,
				t.province_code) a
	</select>
	
	<select id="getAgentBillDiscountList" resultType="java.util.Map">
		select providerName,province_code,discount,group_concat(billPkgName Separator ',') as billPkgName 
			from (SELECT
			a.*, b. NAME AS providerName,
			c. NAME AS billPkgName
			FROM mp_agent_bill_discount a
			LEFT JOIN mp_provider b ON a.provider_id = b.id
			LEFT JOIN mp_bill_pkg c ON a.bill_pkg_id = c.id
			<include refid="myWhere" />
			ORDER BY a.province_code) as t
			group by providerName,province_code,discount
	</select>
	
	<select id="getAgentBillDiscountPkgListBySuId" resultType="java.util.Map">
		select a.id,b.name providerId,c.name pkgName,a.province_code provinceCode,a.discount from mp_agent_bill_discount a 
			LEFT JOIN mp_provider b ON a.provider_id = b.id
			LEFT JOIN mp_bill_pkg c ON a.bill_pkg_id = c.id
		where a.agent_id=#{agentId} and a.del_flag = 1
		order by a.discount
	</select>
	
	<select id='selectCountByAgentId' resultType="java.lang.Integer">
		select count(0) from mp_agent_bill_discount where agent_id=#{agentId} and del_flag = 1
	</select>
	<select id="getAgentBillDiscountPkgList" resultType="java.util.Map">
	select a.* from mp_bill_pkg a where a.del_flag = 1 and a.id in (SELECT DISTINCT b.bill_pkg_id FROM mp_agent_bill_discount b 
	WHERE b.del_flag = 1 
	and b.agent_id =#{agentId,jdbcType=VARCHAR} 
	and b.provider_id = #{providerId,jdbcType=VARCHAR} 
	<if test="provinceCode != null and provinceCode !=''">
       and b.province_code = #{provinceCode,jdbcType=VARCHAR}
    </if>
	and b.bill_pkg_id in (SELECT c.id from mp_bill_pkg c WHERE c.del_flag = 1))
	order by a.value
	</select>
	<select id="selectByBillType" resultType="java.util.Map">
	SELECT a.*,b.id AS billPkgId FROM mp_agent_bill_discount a 
	LEFT JOIN mp_bill_pkg b on a.bill_pkg_id = b.id 
	WHERE a.del_flag = 1 
	and a.agent_id =#{agentId,jdbcType=VARCHAR} 
	and a.provider_id = #{providerId,jdbcType=VARCHAR} 
	and a.province_code = #{provinceCode,jdbcType=VARCHAR}
	and a.bill_pkg_id in (SELECT id from mp_bill_pkg WHERE bill_type =#{billType,jdbcType=VARCHAR} and del_flag = 1)
	</select>
	<select id="selectByPrimaryKey" parameterType="java.lang.String"
		resultType="java.util.Map">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		select
		<include refid="Base_Column_List" />
		FROM
		mp_agent_bill_discount a
		LEFT JOIN mp_provider b ON a.provider_id=b.id LEFT JOIN mp_bill_pkg c on
		a.bill_pkg_id=c.id 
		where a.id = #{id,jdbcType=VARCHAR} and a.del_flag = 1
	</select>
	<select id="agentBillDiscountGet" resultType="java.util.Map">
	SELECT discount FROM mp_agent_bill_discount a
	<include refid="myWhere" />
	</select>
	<select id="agentBillDiscountGetForRYC" resultType="java.util.Map">
	SELECT discount FROM mp_agent_bill_discount a
	<include refid="myWhere" />
	</select>
	<select id="selectAll" resultType="java.util.Map">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		select
		<include refid="Base_Column_List" />
		FROM
		mp_agent_bill_discount a
		LEFT JOIN mp_provider b ON a.provider_id=b.id LEFT JOIN mp_bill_pkg c on
		a.bill_pkg_id=c.id 
		<include refid="myWhere" />
	</select>
	<update id="deleteByPrimaryKey" parameterType="java.lang.String">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update mp_agent_bill_discount set del_flag = 0 where id = #{id,jdbcType=VARCHAR}
	</update>
	<update id="delByAgentAndProvider">
	update mp_agent_bill_discount,mp_bill_pkg set mp_agent_bill_discount.del_flag = 0
	where mp_agent_bill_discount.bill_pkg_id = mp_bill_pkg.id 
	and mp_bill_pkg.bill_type =  #{billType,jdbcType=VARCHAR}
	and mp_agent_bill_discount.agent_id= #{agentId,jdbcType=VARCHAR}
	and mp_agent_bill_discount.provider_id =#{providerId,jdbcType=VARCHAR}
	</update>
	<update id="deleteDiscount">
	update mp_agent_bill_discount set del_flag = 0 where 
	agent_id=#{agentId,jdbcType=VARCHAR}
	 and province_code=#{provinceCode,jdbcType=VARCHAR} and provider_id=#{providerId,jdbcType=VARCHAR}
	 and bill_pkg_id=#{billPkgId,jdbcType=VARCHAR}
	</update>

	<insert id="insert" parameterType="java.util.Map">
		<selectKey keyProperty="myuuid" resultType="String" order="BEFORE">select
			replace(uuid(),'-','') as myuuid from dual</selectKey>
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into mp_agent_bill_discount (id,agent_id,provider_id,name,discount,
		bill_pkg_id,province_code,create_date,create_user)VALUES(#{myuuid,jdbcType=VARCHAR},
		#{agentId,jdbcType=VARCHAR},#{provider,jdbcType=VARCHAR},#{name,jdbcType=VARCHAR},
		#{discount,jdbcType=DECIMAL},#{billPkg,jdbcType=VARCHAR},#{provin,jdbcType=VARCHAR},
		CURRENT_TIMESTAMP,#{createUser,jdbcType=VARCHAR})
	</insert>
	<insert id="insertSelective" parameterType="java.util.Map">
	<selectKey keyProperty="myuuid" resultType="String" order="BEFORE">select  replace(uuid(),'-','') as myuuid  from dual</selectKey>
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into mp_agent_bill_discount
    <trim prefix="(" suffix=")" suffixOverrides=",">
        id,
      <if test="agentId != null and agentId !=''">
        agent_id,
      </if>
      <if test="providerId != null and providerId !=''">
        provider_id,
      </if>
      <if test="name != null and name !=''">
        name,
      </if>
      <if test="discount != null and discount !=''">
        discount,
      </if>
      <if test="billPkgId != null and billPkgId !=''">
        bill_pkg_id,
      </if>   
      <if test="provinceCode != null and provinceCode !=''">
         province_code,
      </if> 
      <if test="cityCode != null and cityCode !=''">
         city_code,
      </if> 
        create_date,     
      <if test="createUser != null and createUser !=''">
        create_user,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      	#{myuuid,jdbcType=VARCHAR},
      <if test="agentId != null and agentId !=''">
        #{agentId,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null and providerId !=''">
        #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="name != null and name !=''">
         #{name,jdbcType=VARCHAR},
      </if>
      <if test="discount != null and discount !=''">
       #{discount,jdbcType=DECIMAL},
      </if>
      <if test="billPkgId != null and billPkgId !=''">
        #{billPkgId,jdbcType=VARCHAR},
      </if>   
      <if test="provinceCode != null and provinceCode !=''">
         #{provinceCode,jdbcType=VARCHAR},
      </if> 
      <if test="cityCode != null and cityCode !=''">
        #{cityCode,jdbcType=VARCHAR},
      </if> 
        CURRENT_TIMESTAMP,     
      <if test="createUser != null and createUser !=''">
        #{createUser,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
	
	<update id="updateByPrimaryKeySelective" parameterType="java.util.Map">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update mp_agent_bill_discount
		<set>
			<if test="providerId != null and providerId != '' ">
				provider_id = #{providerId,jdbcType=VARCHAR},
			</if>
			<if test="name != null and name != ''">
				name = #{name,jdbcType=VARCHAR},
			</if>
			<if test="discount != null and discount != ''">
				discount = #{discount,jdbcType=DECIMAL},
			</if>
			<if test="billPkgId != null and billPkgId != ''">
				bill_pkg_id = #{billPkgId,jdbcType=VARCHAR},
			</if>
			<if test="provinceCode != null and provinceCode != ''">
				province_code = #{provinceCode,jdbcType=VARCHAR},
			</if>			
				update_date = CURRENT_TIMESTAMP,
			<if test="updateUser != null and updateUser != ''">
				update_user = #{updateUser,jdbcType=VARCHAR},
			</if>
		</set>
		where id = #{id,jdbcType=VARCHAR}
	</update>
	<update id="updateDiscount" parameterType="java.util.Map">
	update mp_agent_bill_discount set discount = #{discount,jdbcType=DECIMAL}
	where agent_id = #{agentId,jdbcType=VARCHAR} and provider_id = #{providerId,jdbcType=VARCHAR}
	 and province_code = #{provinceCode,jdbcType=VARCHAR} and bill_pkg_id = #{billPkgId,jdbcType=VARCHAR} and del_flag = 1
	</update>
	<update id="updateDiscountDel" parameterType="java.util.Map">
		update mp_agent_bill_discount set del_flag=0
		where provider_id=#{providerId}
		and agent_id=#{agentId}
	</update>
	<delete id="discountDel" parameterType="java.util.Map">
		delete from 
			mp_agent_bill_discount
		where
			provider_id=#{providerId}
			and agent_id=#{agentId}
	</delete>
	<delete id="discountDelByAgentId" parameterType="java.util.Map">
		delete from 
			mp_agent_bill_discount
		where
			agent_id=#{agentId}
	</delete>
	<select id="selectDiscount" resultType="java.lang.Double">
		select IFNULL((
		select
		  discount
		from mp_agent_bill_discount a 
		where a.del_flag = 1
		<if test="agentId != null and agentId !='' ">
       		and a.agent_id = #{agentId,jdbcType=VARCHAR}
	    </if>
	     <if test="providerId != null and providerId !=''">
	       and a.provider_id = #{providerId,jdbcType=VARCHAR}
	    </if>
	     <if test="provinceCode != null and provinceCode !=''">
	       and a.province_code in('全国', #{provinceCode,jdbcType=VARCHAR})
	    </if>
	     <if test="billPkgId != null and billPkgId !=''">
	       and a.bill_pkg_id = #{billPkgId,jdbcType=VARCHAR}
	    </if>
		order by discount limit 0,1
		),0)
	</select>
	
	<select id="getAllParentAgentBillDiscount" resultType="java.util.Map">
		select
		  a.id,a.agent_id,a.discount
		from mp_agent_bill_discount a 
		where a.del_flag = 1
		<if test="parentAgentId != null and parentAgentId !='' ">
       		and a.agent_id in
     		<foreach collection="parentAgentId" index="index" item="item" open="(" separator="," close=")">  
		        #{item}  
		    </foreach> 
	    </if>
	     <if test="providerId != null and providerId !=''">
	       and a.provider_id = #{providerId,jdbcType=VARCHAR}
	    </if>
	     <if test="provinceCode != null and provinceCode !=''">
	       and a.province_code in('全国', #{provinceCode,jdbcType=VARCHAR})
	    </if>
	     <if test="billPkgId != null and billPkgId !=''">
	       and a.bill_pkg_id = #{billPkgId,jdbcType=VARCHAR}
	    </if>
	</select>
	<!-- 	查询虚商折扣 -->
	<select id="selectVpd" resultType="java.lang.Double">
		select IFNULL((
		select
		   distinct discount
		from mp_agent_bill_discount a 
		where a.del_flag = 1
		<if test="agentId != null and agentId !='' ">
       		and a.agent_id = #{agentId,jdbcType=VARCHAR}
	    </if>
	     <if test="providerId != null and providerId !=''">
	       and a.provider_id = #{providerId,jdbcType=VARCHAR}
	    </if>
	     <if test="provinceCode != null and provinceCode !=''">
	       and a.province_code in('全国', #{provinceCode,jdbcType=VARCHAR})
	    </if>
		),0)
	</select>
	<select id="checkProvince" resultType="java.lang.Integer">
		select count(1) from mp_provider_group_bill_rel where del_flag = 1
		<if test="providerId != null and providerId != ''">
			and provider_id = #{providerId,jdbcType=VARCHAR}
		</if>
		<if test="groupId != null and groupId != ''">
			and group_id = #{groupId,jdbcType=VARCHAR}
		</if>
		<if test="provinceCode != null and provinceCode != ''">
			and province_code = #{provinceCode,jdbcType=VARCHAR}
		</if>
	</select>
	<select id="selectDiscountMap" resultType="java.util.Map">
		select
		*
		from mp_agent_bill_discount a 
		where a.del_flag = 1
		<if test="agentId != null and agentId !='' ">
       		and a.agent_id = #{agentId,jdbcType=VARCHAR}
	    </if>
	     <if test="providerId != null and providerId !=''">
	       and a.provider_id = #{providerId,jdbcType=VARCHAR}
	    </if>
	     <if test="provinceCode != null and provinceCode !=''">
	       and a.province_code in('全国', #{provinceCode,jdbcType=VARCHAR})
	    </if>
	     <if test="billPkgId != null and billPkgId !=''">
	       and a.bill_pkg_id = #{billPkgId,jdbcType=VARCHAR}
	    </if>
		order by discount limit 0,1
	</select>
	
	<sql id="myWhere">
    <where>
	<if test="agentId != null and agentId !='' ">
       and a.agent_id = #{agentId,jdbcType=VARCHAR}
    </if>
     <if test="name != null and name !='' ">
       and a.name = #{name,jdbcType=VARCHAR}
    </if>
     <if test="providerId != null and providerId !=''">
       and a.provider_id = #{providerId,jdbcType=VARCHAR}
    </if>
     <if test="provinceCode != null and provinceCode !=''">
       and a.province_code in('全国',#{provinceCode,jdbcType=VARCHAR}) 
    </if>
     <if test="cityCode != null and cityCode !=''">
       and a.city_code = #{cityCode,jdbcType=VARCHAR}
    </if>
     <if test="discount != null and discount !=''">
       and a.discount = #{discount,jdbcType=DECIMAL}
    </if>
     <if test="billPkgId != null and billPkgId !=''">
       and a.bill_pkg_id = #{billPkgId,jdbcType=VARCHAR}
    </if>
     <if test="updateDate != null and updateDate != ''">
       and a.update_date = #{updateDate,jdbcType=TIMESTAMP}
    </if>
    <if test="updateUser != null and updateUser !=''">
       and a.update_user = #{updateUser,jdbcType=VARCHAR}
    </if>
    <if test="createDate != null and createDate != ''">
       and a.create_date = #{createDate,jdbcType=TIMESTAMP}
    </if>
    <if test="createUser != null and createUser !=''">
       and a.create_user = #{createUser,jdbcType=VARCHAR}
    </if>
    and a.del_flag = 1
    </where>
    </sql>
    
    <select id="selectAgentBillDiscountListByAgentid" resultType="java.util.Map">
		select * from mp_agent_bill_discount where agent_id = #{agentId,jdbcType=VARCHAR} and del_flag = 1
	</select>
	
	<!--查询活动信息 -->
	<select id="selectActivity" resultType="java.util.Map">
		SELECT * FROM `mp_activity`
	</select>
	
	<!--修改参与活动的人数 -->
	<update id="updateActivity" parameterType="java.lang.String">
	    update mp_activity set places = #{places,jdbcType=VARCHAR}
    </update>
    
	<update id="updataActivityPlaces" parameterType="java.util.Map">
	<!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
		update mp_activity 
	 	<set>
	      <if test="places != null and places !=''">
	        places = #{places,jdbcType=VARCHAR},
	      </if>
	      <if test="current_time != null and current_time !=''">
	        `current_time` = #{current_time,jdbcType=VARCHAR},
	      </if>
	 	</set>
	 	where 1 =1 
    </update>
</mapper>