<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hyfd.dao.mp.AgentAccountChargeDao">
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    a.id, a.agent_id, a.order_id, a.fee, a.balance_before, a.balance_after,
    date_format(a.apply_date, '%Y-%m-%d %H:%i:%s') as apply_date,
    date_format(a.end_date, '%Y-%m-%d %H:%i:%s') as end_date,a.type,a.status,
    b.name
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from mp_agent_account_charge
    where id = #{id,jdbcType=VARCHAR} and del_flag = 1
  </select>
  <select id="selectCount" resultType="Integer">
  select count(1) from mp_agent_account_charge a left join mp_agent b on a.agent_id=b.id where a.del_flag = 1
    <if test="agentParentId != null and agentParentId != ''" >
	      and a.agent_id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId} and del_flag = 1)
	 </if>
    <if test="agentOrderId != null and agentOrderId != ''">
       and a.agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
    </if>
    <if test="fee != null and fee != ''">
       and a.fee = #{fee,jdbcType=DECIMAL}
    </if>
    <if test="balanceBefore != null and balanceBefore != ''">
       and a.balance_before = #{balanceBefore,jdbcType=DECIMAL}
    </if>
    <if test="balanceAfter != null and balanceAfter != ''">
       and a.balance_after = #{balanceAfter,jdbcType=DECIMAL}
    </if>
    <if test="applyDate != null and applyDate != ''">
       and a.apply_date &gt;= #{applyDate,jdbcType=TIMESTAMP}
    </if>
    <if test="endDate != null and endDate != ''">
       and a.apply_date &lt;= #{endDate,jdbcType=TIMESTAMP}
    </if>
    <if test="type != null and type != ''">
       and a.type = #{type,jdbcType=VARCHAR}
    </if>
    <if test="status != null and status != ''">
       and a.status = #{status,jdbcType=VARCHAR}
    </if>
    <if test="agentName != null and agentName != ''">
       and b.name = #{agentName,jdbcType=VARCHAR}
    </if>
  </select>
  
  <select id="selectAll" resultType="java.util.Map">
   select 
    a.id, a.agent_id,a.agent_order_id, a.fee, a.balance_before, a.balance_after,
    date_format(a.apply_date, '%Y-%m-%d %H:%i:%s.%f') as apply_date,
    date_format(a.end_date, '%Y-%m-%d %H:%i:%s.%f') as end_date,
    case
    when a.type = '1' then '话费'
    when a.type = '2' then '话费'
    else ''
    end as type,
    case
    when a.status = '1' then '扣款'
    when a.status = '2' then '退款'
    when a.status = '3' then '加款'
    when a.status = '4' then '调账'
    else ''
    end as status,
    b.name,a.remark
    from mp_agent_account_charge a left join mp_agent b
    on a.agent_id = b.id
    where a.del_flag = 1 AND a.agent_id=b.id  
    <if test="agentParentId != null and agentParentId != ''" >
	  and a.agent_id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId} and del_flag = 1)
	 </if>
	<if test="agentParentId != null and agentParentId != ''" >
      and b.id in(select id from mp_agent where parent_id=#{agentParentId} or id=#{agentParentId} and del_flag = 1)
   	</if>
    <if test="agentOrderId != null and agentOrderId != ''">
       and a.agent_order_id = #{agentOrderId,jdbcType=VARCHAR}
    </if>
    <if test="fee != null and fee != ''">
       and a.fee = #{fee,jdbcType=DECIMAL}
    </if>
    <if test="balanceBefore != null and balanceBefore != ''">
       and a.balance_before = #{balanceBefore,jdbcType=DECIMAL}
    </if>
    <if test="balanceAfter != null and balanceAfter != ''">
       and a.balance_after = #{balanceAfter,jdbcType=DECIMAL}
    </if>
     <if test="applyDate != null and applyDate != ''">
       and a.apply_date &gt;= #{applyDate,jdbcType=TIMESTAMP}
    </if>
    <if test="endDate != null and endDate != ''">
       and a.apply_date &lt;= #{endDate,jdbcType=TIMESTAMP}
    </if>
     <if test="type != null and type != ''">
       and a.type = #{type,jdbcType=VARCHAR}
    </if>
     <if test="status != null and status != ''">
       and a.status = #{status,jdbcType=VARCHAR}
    </if>
    <if test="agentName != null and agentName != ''">
       and b.name = #{agentName,jdbcType=VARCHAR}
    </if>
    order by a.end_date desc
  </select>
  <select id="countProfit" resultType="java.lang.Double">
	select IFNULL(( 
	    select 
	    	sum(a.fee)
	    from mp_agent_account_charge a left join mp_agent b on a.agent_id = b.id where a.del_flag = 1 and b.del_flag = 1 and a.type !=3
	    <if test="agentId != null and agentId != ''">
	    	and a.agent_id = #{agentId,jdbcType=VARCHAR}
	    </if>
	    <if test="parentId != null and parentId != ''">
	    	and b.parent_id = #{parentId,jdbcType=VARCHAR}
	    </if>
	    <if test = "isToday">
	    	and a.apply_date &gt; CURDATE()
	    </if>
	),0)
  </select>
   <select id="countOrder" resultType="java.lang.Integer">
	    select 
	    	count(1)
	    from mp_agent_account_charge where del_flag = 1
	    <if test="agentId != null and agentId != ''">
	    	and agent_id = #{agentId,jdbcType=VARCHAR}
	    </if>
	    <if test="isFail">
	    	and fee &gt; 0
	    </if>
	    <if test="isAll">
	    	and fee &lt; 0
	    </if>
	    <if test = "isToday">
	    	and DATE(apply_date) = CURDATE()
	    </if>
  </select>
  <select id="selectReceiptList" resultType="java.util.Map">
  	SELECT
		c.nickname AS agentName,
		date_format(a.apply_date, '%Y-%m-%d') AS applyDate,
		b.remark AS payName,
		a.fee AS fee,
		b.money_account AS moneyAccount
	FROM
		mp_agent_account_charge a
	LEFT JOIN mp_agent_account_charge_audit b ON a.order_id = b.id
	LEFT JOIN mp_agent c ON a.agent_id = c.id 
	WHERE a.type = 3 and a.del_flag = 1
	<if test="nickName != null and nickName != ''">
		and c.nickname = #{nickName,jdbcType=VARCHAR}
	</if>
	<if test="paymoneyName != null and paymoneyName != ''">
		and b.paymoney_name = #{paymoneyName,jdbcType=VARCHAR}
	</if>
	<if test="moneyAccount != null and moneyAccount != ''">
		and b.money_account = #{moneyAccount,jdbcType=VARCHAR}
	</if>
	<if test="startDate != null and startDate != ''">
		and a.apply_date &gt; #{startDate,jdbcType=VARCHAR}
	</if>
	<if test="endDate != null and endDate != ''">
		and a.apply_date &lt; #{endDate,jdbcType=VARCHAR}
	</if>
	ORDER BY a.apply_date DESC
  </select>
  <!-- 获取代理商合并数据 -->
  <select id="selectMergeReceiptList" resultType="java.util.Map">
  	SELECT
		c.nickname AS agentName,
		date_format(a.apply_date, '%Y-%m-%d') AS applyDate,
		b.paymoney_name AS payName,
		SUM(a.fee) AS fee,
		b.money_account AS moneyAccount
	FROM
		mp_agent_account_charge a
	LEFT JOIN mp_agent_account_charge_audit b ON a.order_id = b.id
	LEFT JOIN mp_agent c ON a.agent_id = c.id 
	WHERE a.type = 3 and a.del_flag = 1
	<if test="nickName != null and nickName != ''">
		and c.nickname = #{nickName,jdbcType=VARCHAR}
	</if>
	<if test="paymoneyName != null and paymoneyName != ''">
		and b.paymoney_name = #{paymoneyName,jdbcType=VARCHAR}
	</if>
	<if test="moneyAccount != null and moneyAccount != ''">
		and b.money_account = #{moneyAccount,jdbcType=VARCHAR}
	</if>
	<if test="startDate != null and startDate != ''">
		and a.apply_date &gt; #{startDate,jdbcType=VARCHAR}
	</if>
	<if test="endDate != null and endDate != ''">
		and a.apply_date &lt; #{endDate,jdbcType=VARCHAR}
	</if>
	GROUP BY a.agent_id
  </select>
  <update id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update mp_agent_account_charge set del_flag = 0 where id = #{id,jdbcType=VARCHAR}
  </update>
  <insert id="insert" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into mp_agent_account_charge (id, agent_id, order_id, 
      fee, balance_before, balance_after, 
      apply_date, end_date)
    values (#{id,jdbcType=VARCHAR}, #{agentId,jdbcType=VARCHAR}, #{orderId,jdbcType=VARCHAR}, 
      #{fee,jdbcType=DECIMAL}, #{balanceBefore,jdbcType=DECIMAL}, #{balanceAfter,jdbcType=DECIMAL}, 
      #{applyDate,jdbcType=TIMESTAMP}, #{endDate,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into mp_agent_account_charge
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null and id != ''">
        id,
      </if>
      <if test="agentId != null and agentId != ''">
        agent_id,
      </if>
      <if test="orderId != null and orderId != ''">
        order_id,
      </if>
      <if test="agentOrderId != null and agentOrderId != ''">
      	agent_order_id,
      </if>
      <if test="fee != null and fee != ''">
        fee,
      </if>
      <if test="balanceBefore != null and balanceBefore != ''">
        balance_before,
      </if>
      <if test="balanceAfter != null and balanceAfter != ''">
        balance_after,
      </if>
      <if test="type != null and type != ''">
      	type,
      </if>
      <if test="status != null and status != ''">
      	status,
      </if>
      <if test="applyDate != null">
        apply_date,
      </if>
      <if test="remark != null">
        remark,
      </if>
        end_date
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null and id != ''">
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="agentId != null and agentId != ''">
        #{agentId,jdbcType=VARCHAR},
      </if>
      <if test="orderId != null and orderId != ''">
        #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="agentOrderId != null and agentOrderId != ''">
      	#{agentOrderId,jdbcType=VARCHAR},
      </if>
      <if test="fee != null and fee != ''">
        #{fee,jdbcType=DECIMAL},
      </if>
      <if test="balanceBefore != null and balanceBefore != ''">
        #{balanceBefore,jdbcType=DECIMAL},
      </if>
      <if test="balanceAfter != null and balanceAfter != ''">
        #{balanceAfter,jdbcType=DECIMAL},
      </if>
      <if test="type != null and type != ''">
      	#{type,jdbcType=VARCHAR},
      </if>
      <if test="status != null and status != ''">
      	#{status,jdbcType=VARCHAR},
      </if>
      <if test="applyDate != null">
        #{applyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="remark != null">
        #{remark,jdbcType=VARCHAR},
      </if>
        now(3)
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update mp_agent_account_charge
    <set>
      <if test="agentId != null and agentId != ''">
        agent_id = #{agentId,jdbcType=VARCHAR},
      </if>
      <if test="orderId != null and orderId != ''">
        order_id = #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="fee != null and fee != ''">
        fee = #{fee,jdbcType=DECIMAL},
      </if>
      <if test="balanceBefore != null and balanceBefore != ''">
        balance_before = #{balanceBefore,jdbcType=DECIMAL},
      </if>
      <if test="balanceAfter != null and balanceAfter != ''">
        balance_after = #{balanceAfter,jdbcType=DECIMAL},
      </if>
      <if test="applyDate != null">
        apply_date = #{applyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="endDate != null">
        end_date = #{endDate,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
  
  <select id="checkDistinctOrder" resultType="java.lang.Integer">
  	select count(1) from mp_agent_account_charge 
  	where agent_id = #{agentId,jdbcType=VARCHAR} and status not in('1','2')
  		and fee = #{fee,jdbcType=VARCHAR} and apply_date >= SUBDATE(NOW(),INTERVAL 3 MINUTE)
  </select>
  <select id="selectChargeList" resultType="java.util.Map">
  	SELECT agent_id as agentId,ABS(fee) as money from mp_agent_account_charge where agent_order_id = #{agentOrderId,jdbcType=VARCHAR};
  </select>
  
  <select id="exportNewCustomerAgent" resultType="java.util.Map">
  	SELECT a.`name`,a.nickname,sum(fee) fee,suName,date_format(d.apply_date, '%Y-%m-%d') apply_date FROM mp_agent_account_charge c,
		(SELECT	MIN(apply_date) apply_date,agent_id FROM mp_agent_account_charge
		WHERE `status` = '3' GROUP BY agent_id ) d,mp_agent a,sysusert s
	WHERE c.`status` = '3' AND d.agent_id = c.agent_id AND d.apply_date = c.apply_date
	AND a.id = c.agent_id AND s.suId = a.channel_person AND d.apply_date &gt; #{startDate,jdbcType=VARCHAR}
	AND d.apply_date &lt; #{endDate,jdbcType=VARCHAR}
	GROUP BY c.agent_id
  </select>
  
  <select id="exportMonthlyAddMoneyAgent" resultType="java.util.Map">
  	SELECT	a.`name`,a.nickname,sum(fee) fee,suName FROM mp_agent_account_charge c
	LEFT JOIN mp_agent a ON a.id = c.agent_id
	LEFT JOIN sysusert s ON s.suId = a.channel_person
	WHERE c.`status` = '3' AND c.apply_date &gt; #{startDate,jdbcType=VARCHAR} AND c.apply_date &lt; #{endDate,jdbcType=VARCHAR}
	GROUP BY c.agent_id
  </select>
  
</mapper>