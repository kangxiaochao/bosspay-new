<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hyfd.dao.mp.ProviderBillRechargeGroupDao">
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, provider_id, provider_physical_channel_id,province_code, priority, update_date, update_user, create_date, 
    create_user
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from mp_provider_bill_recharge_group
    where id = #{id,jdbcType=VARCHAR}
  </select>
  <!-- 统计数量 -->
  <select id="selectCount" resultType="Integer">
      select  count(1) from mp_provider_bill_recharge_group pdrg
	LEFT JOIN mp_provider p ON p.id = pdrg.provider_id
	LEFT JOIN mp_provider_physical_channel ppc ON ppc.id = pdrg.provider_physical_channel_id
    where pdrg.del_flag=1 and p.del_flag=1 and ppc.del_flag=1
    <if test="name != null">
      and p.name like concat('%',#{name,jdbcType=VARCHAR},'%') 
    </if>
    <if test="physicalChannel != null &amp;&amp; physicalChannel !='' ">
      and ppc.name like concat('%',#{physicalChannel,jdbcType=VARCHAR},'%') 
    </if>
  </select>
  <!-- <select id="selectAll" resultType="java.util.Map">
    
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
   
    select 
    <include refid="Base_Column_List" />
    from mp_provider_bill_recharge_group where 1 = 1 
    <if test="providerId != null">
       and provider_id = #{providerId,jdbcType=VARCHAR}
    </if>
    <if test="dispatcherProviderId != null">
       and dispatcher_provider_id = #{dispatcherProviderId,jdbcType=VARCHAR}
    </if>
    <if test="priority != null">
       and priority = #{priority,jdbcType=INTEGER}
    </if>
    <if test="updateDate != null">
       and update_date = #{updateDate,jdbcType=TIMESTAMP}
    </if>
    <if test="updateUser != null">
       and update_user = #{updateUser,jdbcType=VARCHAR}
    </if>
    <if test="createDate != null">
       and create_date = #{createDate,jdbcType=TIMESTAMP}
    </if>
    <if test="createUser != null">
       and create_user = #{createUser,jdbcType=VARCHAR}
    </if>
  </select> -->
  <!-- 查询类别 -->
  <select id="selectAll" resultType="java.util.Map">
     SELECT
     	pdrg.id,
     	pdrg.provider_id providerId,
		p. NAME name,
		pdrg.province_code provinceCode,
		ppc.`name` physicalChannel,
		pdrg.priority,
		date_format( pdrg.create_date, '%Y-%m-%d %H:%i' ) createDate
	FROM
		mp_provider_bill_recharge_group pdrg
	LEFT JOIN mp_provider p ON p.id = pdrg.provider_id
	LEFT JOIN mp_provider_physical_channel ppc ON ppc.id = pdrg.provider_physical_channel_id
	where pdrg.del_flag=1 and p.del_flag=1 and ppc.del_flag=1
	<if test="name != null">
      and p.name like concat('%',#{name,jdbcType=VARCHAR},'%') 
    </if>
    <if test="physicalChannel != null &amp;&amp; physicalChannel !='' ">
      and ppc.name like concat('%',#{physicalChannel,jdbcType=VARCHAR},'%') 
    </if>
	GROUP BY p.`name`,pdrg.province_code,pdrg.priority
  </select>
  <!-- 根据优先级找ID -->
  <select id="getRechargeIdByPriority" resultType="java.lang.String" parameterType="java.util.Map">
  	select id from mp_provider_bill_recharge_group
  	where del_flag=1 and provider_id=#{providerId} and province_code=#{provinceCode} and priority=#{priority}
  </select>
  <select id="getMaxPriority" resultType="java.lang.Integer" parameterType="java.util.Map">
  	SELECT
     	MAX(pdrg.priority) maxPr
	FROM
		mp_provider_bill_recharge_group pdrg
	LEFT JOIN mp_provider p ON p.id = pdrg.provider_id
	LEFT JOIN mp_provider_physical_channel ppc ON ppc.id = pdrg.provider_physical_channel_id
	where pdrg.del_flag=1 and p.del_flag=1 and ppc.del_flag=1 and pdrg.provider_id=#{providerId} and pdrg.province_code=#{provinceCode}
	GROUP BY p.`name`,pdrg.province_code;
  </select>
  <update id="deleteByPrimaryKey" parameterType="java.lang.String">
    update mp_provider_bill_recharge_group set del_flag=0
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <insert id="insert" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <selectKey keyProperty="myuuid" resultType="String" order="BEFORE">select  replace(uuid(),'-','') as myuuid  from dual</selectKey>
    insert into mp_provider_bill_recharge_group (id, provider_id, provider_physical_channel_id, 
      province_code,priority, update_date, update_user, 
      create_date, create_user)
      select 
      	#{myuuid,jdbcType=VARCHAR}, 
      	#{providerId,jdbcType=VARCHAR}, 
      	#{physicalChannel,jdbcType=VARCHAR}, 
     	#{provinceCode,jdbcType=VARCHAR},
     	IFNULL(max(CONVERT(priority, SIGNED)) + 1, 1),
     	now(), 
     	#{updateUser,jdbcType=VARCHAR}, 
      now(), 
      #{createUser,jdbcType=VARCHAR}
      from mp_provider_bill_recharge_group 
      where provider_id=#{providerId}
      and province_code = #{provinceCode} 
  </insert>
  <insert id="insertSelective" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into mp_provider_bill_recharge_group
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="providerId != null">
        provider_id,
      </if>
      <if test="dispatcherProviderId != null">
        dispatcher_provider_id,
      </if>
      <if test="priority != null">
        priority,
      </if>
      <if test="updateDate != null">
        update_date,
      </if>
      <if test="updateUser != null">
        update_user,
      </if>
      <if test="createDate != null">
        create_date,
      </if>
      <if test="createUser != null">
        create_user,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="providerId != null">
        #{providerId,jdbcType=VARCHAR},
      </if>
      <if test="dispatcherProviderId != null">
        #{dispatcherProviderId,jdbcType=VARCHAR},
      </if>
      <if test="priority != null">
        #{priority,jdbcType=INTEGER},
      </if>
      <if test="updateDate != null">
        #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUser != null">
        #{updateUser,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null">
        #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createUser != null">
        #{createUser,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="java.util.Map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update mp_provider_bill_recharge_group
    set provider_id=#{providerId},
    	provider_physical_channel_id=#{physicalChannel},
    	province_code = #{provinceCode},
    	update_date = now(),
    	update_user = null
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateRechargePriority" parameterType="java.util.Map">
    update mp_provider_bill_recharge_group
    set priority=#{priority},
    	update_date = now(),
    	update_user = null
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <select id="selectByProviderId" parameterType="java.lang.String" resultType="java.util.Map">
<!--      SELECT
	DISTINCT a.provider_physical_channel_id
	FROM
		mp_provider_bill_recharge_group a
	INNER JOIN mp_provider_bill_discount b ON a.provider_physical_channel_id = b.provider_physical_channel_id
	WHERE
		a.provider_id = #{providerId,jdbcType=VARCHAR}
	AND a.province_code = #{provinceCode,jdbcType=VARCHAR}
	and b.province_code = #{provinceCode,jdbcType=VARCHAR}
	and b.bill_pkg_id = #{pkgId,jdbcType=VARCHAR}
	order by a.priority -->
	
	SELECT
		 id,provider_physical_channel_id,provider_id,discount,province_code
	FROM
		mp_provider_bill_discount
	WHERE
		del_flag=1 and
		bill_pkg_id = #{pkgId,jdbcType=VARCHAR}
		and (provider_id ,provider_physical_channel_id,province_code) in(
			select provider_id,provider_physical_channel_id,province_code from
			mp_provider_bill_recharge_group 
			where del_flag=1 and provider_id = #{providerId,jdbcType=VARCHAR}
			and province_code in('全国',#{provinceCode,jdbcType=VARCHAR})
		)order by discount
  </select>
<!-- 	 <select id="selectByProviderId" parameterType="java.lang.String" resultType="java.lang.String"> -->
<!--      	SELECT -->
<!-- 			provider_physical_channel_id -->
<!-- 		FROM -->
<!-- 			mp_provider_bill_discount -->
<!-- 		WHERE -->
<!-- 			provider_id = #{providerId,jdbcType=VARCHAR} -->
<!-- 		and province_code = #{provinceCode,jdbcType=VARCHAR} -->
<!-- 		and bill_pkg_id = #{pkgId,jdbcType=VARCHAR} -->
<!-- 		order by discount -->
<!--   	</select> -->

  <!--     select  -->
<!--     provider_physical_channel_id     -->
<!--     from mp_provider_bill_recharge_group -->
<!--     where provider_id = #{providerId,jdbcType=VARCHAR} and province_code = #{provinceCode,jdbcType=VARCHAR} -->
<!--     order by priority -->
  <!-- 根据id查找复充 -->
  <select id="getBillById" parameterType="java.lang.String" resultType="java.util.Map">
  	select 
  		id,
  		provider_id providerId,
  		province_code provinceCode,
  		priority
  	from mp_provider_bill_recharge_group 
  	where id=#{id}
  </select>
  <!-- 查询删除优先级以下的数据 -->
  <select id="getRechargeBillById" parameterType="java.util.Map" resultType="java.util.Map">
  	select 
  		id,
  		provider_id providerId,
  		province_code provinceCode,
  		priority 
  	from mp_provider_bill_recharge_group 
  	where del_flag=1 and provider_id=#{providerId} and province_code=#{provinceCode} 
  	<![CDATA[
            and priority>#{priority}
    ]]>
  </select>
  <sql id="myWhere">
    <where>
    <if test="name != null">
      and p.name like concat('%',#{name,jdbcType=VARCHAR},'%') 
    </if>
    <if test="physicalChannel != null &amp;&amp; physicalChannel !='' ">
      and ppc.name like concat('%',#{physicalChannel,jdbcType=VARCHAR},'%') 
    </if>
    </where>
  </sql>
</mapper>